<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>kubernetes 1.13 安装指南 - 游戏不存在</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="shawn" /><meta name="description" content="kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有： kubernetes的版本迭" /><meta name="keywords" content="game, docker, kubernetes, python, go,  microservice" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://game404.github.io/post/kubernetes-1.13-guide/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="kubernetes 1.13 安装指南" />
<meta property="og:description" content="kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有： kubernetes的版本迭" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://game404.github.io/post/kubernetes-1.13-guide/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-03-26T23:27:54+08:00" />
<meta property="article:modified_time" content="2019-03-26T23:27:54+08:00" />

<meta itemprop="name" content="kubernetes 1.13 安装指南">
<meta itemprop="description" content="kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有： kubernetes的版本迭"><meta itemprop="datePublished" content="2019-03-26T23:27:54+08:00" />
<meta itemprop="dateModified" content="2019-03-26T23:27:54+08:00" />
<meta itemprop="wordCount" content="4414">
<meta itemprop="keywords" content="指南," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes 1.13 安装指南"/>
<meta name="twitter:description" content="kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有： kubernetes的版本迭"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">游戏不存在</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">游戏不存在</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">kubernetes 1.13 安装指南</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-03-26 </span>
        <div class="post-category">
            <a href="/categories/kubernetes/"> kubernetes </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#机器准备">机器准备</a></li>
        <li><a href="#安装环境准备及安装">安装环境准备及安装</a></li>
        <li><a href="#初始化k8s集群">初始化k8s集群</a></li>
        <li><a href="#dashboard安装">Dashboard安装</a></li>
        <li><a href="#增加master节点">增加Master节点</a></li>
        <li><a href="#主要参考文档">主要参考文档</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有：</p>
<ol>
<li>kubernetes的版本迭代比较迅速。网上教程中版本多是<code>1.6</code>这样的，最新的k8s版本是<code>1.13.0</code></li>
<li>kubernetes的需要安装的rpm包及docker镜像国内直接安装会失败。</li>
<li>官方的中文文档在翻译不全，其中一些内容缺失。</li>
</ol>
<blockquote>
<p>发文时kubernetes1.14.0已经正式发布，稍后会奉上更新手册, 敬请期待。</p>
</blockquote>
<p>我花了一些时间踩坑，主要参考kubernetes官网、github及stack overflow, 成功完成k8s的安装，过程记录如下。</p>
<h3 id="机器准备">机器准备</h3>
<p>我们在内网的2台服务器上开始k8s的安装，机器配置及规划如下表:</p>
<table>
<thead>
<tr>
<th>机器名称</th>
<th>机器IP</th>
<th>CPU</th>
<th>内存</th>
<th>Linux版本</th>
<th>Docker版本</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>192-168-10-21</td>
<td>192.168.10.21</td>
<td>8</td>
<td>16G</td>
<td>CentOS 7.1.1503</td>
<td>17.03.2-ce/17.03.2-ce</td>
<td>master控制节点</td>
</tr>
<tr>
<td>192-168-10-18</td>
<td>192.168.10.18</td>
<td>8</td>
<td>28G</td>
<td>CentOS 7.6.1810</td>
<td>17.03.1-ce/17.03.1-ce</td>
<td>worker业务节点</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Docker版本为:Client Version/Server Version的格式</p>
</blockquote>
<p>本次安装的k8s版本是 <code>v1.13.0</code> ，另外实测CentOS的小版本和Docker的小版本不用完全一致。</p>
<h3 id="安装环境准备及安装">安装环境准备及安装</h3>
<p>安装k8s设备环境要求主要有下面10点：</p>
<pre><code>1. CentOS版本为7以上
2. 2核CPU和2G内存以上
3. 多台机器内网互通
4. 每台机器的主机名、mac地址和product_uuid唯一
5. 测试环境关闭防火墙，保证全部端口开放。
6. 禁用SELinux
7. 禁用交换分区
8. docker服务
9. root账号权限
10. 配置国内的repo源
</code></pre>
<ol>
<li>查看机器CentOS版本</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@192-168-10-21 ~]# cat /etc/centos-release
</span></span><span class="line"><span class="cl">CentOS Linux release 7.1.1503 (Core)
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意CentOS6升级到7比较麻烦，本着少折腾原则，从CentOS7的机器开始会省事一些。</p>
</blockquote>
<ol start="2">
<li>查看机器的cpu和内存信息</li>
</ol>
<p>比较简单和常用的可以使用<code>TOP</code>命令后再按<code>1</code>查看:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">TOP 1
</span></span><span class="line"><span class="cl">Tasks: 200 total,   1 running, 199 sleeping,   0 stopped,   0 zombie
</span></span><span class="line"><span class="cl">%Cpu0  :  2.0 us,  1.0 sy,  0.0 ni, 97.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu1  :  1.0 us,  0.3 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu2  :  0.7 us,  0.7 sy,  0.0 ni, 98.3 id,  0.3 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu3  :  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu4  :  0.7 us,  0.3 sy,  0.0 ni, 99.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu5  :  1.3 us,  0.7 sy,  0.0 ni, 98.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu6  :  0.7 us,  0.7 sy,  0.0 ni, 98.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">%Cpu7  :  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</span></span><span class="line"><span class="cl">KiB Mem : 16207100 total, 13269888 free,   974208 used,  1963004 buff/cache
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面信息可知，机器是8核，内存是16G。</p>
<p>更准确的查看CPU信息:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c
</span></span><span class="line"><span class="cl">      8  Intel(R) Xeon(R) CPU E5-2640 0 @ 2.50GHz
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看内存信息:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># cat /proc/meminfo | grep MemTotal
</span></span><span class="line"><span class="cl">MemTotal:       16207100 kB           0           0           0
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>
<p>多台机器互通，这一般没有问题，不用介绍。</p>
</li>
<li>
<p>检查机器名称、mac及product_uuid的唯一性</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># 查看uuid
</span></span><span class="line"><span class="cl"># cat /sys/class/dmi/id/product_uuid
</span></span><span class="line"><span class="cl">564D0DF3-FB05-2EC7-E989-FFE0F880069C
</span></span><span class="line"><span class="cl"># 查看hostname
</span></span><span class="line"><span class="cl"># hostname
</span></span><span class="line"><span class="cl">192-168-10-21
</span></span><span class="line"><span class="cl"># 查看IP
</span></span><span class="line"><span class="cl"># ifconfig -a
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ens32: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span></span><span class="line"><span class="cl">        inet 192.168.10.21  netmask 255.255.255.0  broadcast 192.168.10.255
</span></span><span class="line"><span class="cl">        inet6 fe80::20c:29ff:fe80:69c  prefixlen 64  scopeid 0x20&lt;link&gt;
</span></span><span class="line"><span class="cl">        ether 00:0c:29:80:06:9c  txqueuelen 1000  (Ethernet)
</span></span><span class="line"><span class="cl">        RX packets 5333851  bytes 529922710 (505.3 MiB)
</span></span><span class="line"><span class="cl">        RX errors 0  dropped 152075  overruns 0  frame 0
</span></span><span class="line"><span class="cl">        TX packets 2560325  bytes 916120110 (873.6 MiB)
</span></span><span class="line"><span class="cl">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></span></code></pre></td></tr></table>
</div>
</div><p>一般来说uuid和mac不可能重复，hostname可能会有重复（因为运维开机器是脚本批处理，可能没有修改hostname）。如果hostname重复，修改的方法如下：</p>
<blockquote>
<p>1 vi /etc/hostname 修改名称。2  vi /etc/hosts 增加机器名称。 3 roboot重启机器。</p>
</blockquote>
<ol start="5">
<li>关闭防火墙</li>
</ol>
<p>k8s对master和worker节点的端口开放有要求：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/26/169bab2a4b11bd92?w=1363&amp;h=496&amp;f=png&amp;s=55087" alt="port"></p>
<p>因为是内网测试服务，我简单粗暴的关闭防火墙即可。</p>
<p>查看firewall状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># systemctl status firewalld
</span></span><span class="line"><span class="cl">● firewalld.service - firewalld - dynamic firewall daemon
</span></span><span class="line"><span class="cl">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)
</span></span><span class="line"><span class="cl">   Active: inactive (dead)
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看iptables状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># systemctl status  iptables
</span></span><span class="line"><span class="cl">● iptables.service - IPv4 firewall with iptables
</span></span><span class="line"><span class="cl">   Loaded: loaded (/usr/lib/systemd/system/iptables.service; disabled; vendor preset: disabled)
</span></span><span class="line"><span class="cl">   Active: inactive (dead)
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>关闭防火墙<code>systemctl stop firewalld</code>  停止防护墙开机启动 <code>systemctl disable firewalld</code>。iptables的关闭同理。</p>
</blockquote>
<ol start="6">
<li>禁用SELinux</li>
</ol>
<p>禁用SELinux后，容器才能够访问宿主机文件系统。查看SELinux的状态:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sestatus
</span></span><span class="line"><span class="cl">SELinux status:                 disabled
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>禁用方法 <code>setenforce 0 &amp;&amp; sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config</code></p>
</blockquote>
<ol start="7">
<li>禁用交换分区</li>
</ol>
<p>查看交换分区状态，如果swap数值全部为0，则表示已经禁用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@192-168-10-21 ~]# free -h
</span></span><span class="line"><span class="cl">              total        used        free      shared  buff/cache   available
</span></span><span class="line"><span class="cl">Mem:            15G        940M         13G         17M        1.4G         14G
</span></span><span class="line"><span class="cl">Swap:            0B          0B          0B
</span></span></code></pre></td></tr></table>
</div>
</div><p>禁用方法如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">1. run swapoff -a : this will immediately disable swap.
</span></span><span class="line"><span class="cl">2. remove any swap entry from /etc/fstab.
</span></span><span class="line"><span class="cl">3. reboot.
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>docker服务</li>
</ol>
<p>查看docker版本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@192-168-10-18 ~]# docker version
</span></span><span class="line"><span class="cl">Client:
</span></span><span class="line"><span class="cl"> Version:      17.03.1-ce
</span></span><span class="line"><span class="cl"> API version:  1.27
</span></span><span class="line"><span class="cl"> Go version:   go1.7.5
</span></span><span class="line"><span class="cl"> Git commit:   c6d412e
</span></span><span class="line"><span class="cl"> Built:        Mon Mar 27 17:05:44 2017
</span></span><span class="line"><span class="cl"> OS/Arch:      linux/amd64
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Server:
</span></span><span class="line"><span class="cl"> Version:      17.03.1-ce
</span></span><span class="line"><span class="cl"> API version:  1.27 (minimum version 1.12)
</span></span><span class="line"><span class="cl"> Go version:   go1.7.5
</span></span><span class="line"><span class="cl"> Git commit:   c6d412e
</span></span><span class="line"><span class="cl"> Built:        Mon Mar 27 17:05:44 2017
</span></span><span class="line"><span class="cl"> OS/Arch:      linux/amd64
</span></span><span class="line"><span class="cl"> Experimental: false
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="9">
<li>root账号</li>
</ol>
<p>安装 <code>kubeadm</code> 时候需要使用root账号进行安装。安装完成后推荐非root账号使用 <code>kubectl</code> 命令。</p>
<ol start="10">
<li>配置国内的repo源</li>
</ol>
<p><code>kubeadm</code>使用<code>yum</code>命令进行安装，使用国内阿里云的源，可以安装成功</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat &gt;&gt; /etc/yum.repos.d/kubernetes.repo <span class="s">&lt;&lt;EOF 
</span></span></span><span class="line"><span class="cl"><span class="s">[kubernetes]
</span></span></span><span class="line"><span class="cl"><span class="s">name=Kubernetes
</span></span></span><span class="line"><span class="cl"><span class="s">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class="line"><span class="cl"><span class="s">enabled=1
</span></span></span><span class="line"><span class="cl"><span class="s">gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">repo_gpgcheck=0
</span></span></span><span class="line"><span class="cl"><span class="s">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="11">
<li>修改网络配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改完成后执行<code>sysctl --system</code>应用。</p>
<ol start="12">
<li>安装kubernetes包</li>
</ol>
<p>安装条件全部具备以后， <code>root</code> 账号进入 <code>192-168-10-21</code> ，执行下面命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@192-168-10-21 ~<span class="o">]</span><span class="c1"># yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>完成后启动<code>kubelet</code>服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">systemctl enable kubelet.service
</span></span><span class="line"><span class="cl">systemctl start kubelet.service
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上12项操作需要在所有节点执行。</p>
<h3 id="初始化k8s集群">初始化k8s集群</h3>
<p>1.1 初始化集群</p>
<p>master上使用下面命令初始化k8s:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubeadm init --kubernetes-version v1.13.0 --pod-network-cidr=10.244.0.0/16
</span></span></code></pre></td></tr></table>
</div>
</div><p>成功后会有下面的输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Your Kubernetes master has initialized successfully!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To start using your cluster, you need to run the following as a regular user:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  mkdir -p $HOME/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You should now deploy a pod network to the cluster.
</span></span><span class="line"><span class="cl">Run &#34;kubectl apply -f [podnetwork].yaml&#34; with one of the options listed at:
</span></span><span class="line"><span class="cl">  https://kubernetes.io/docs/concepts/cluster-administration/addons/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">You can now join any number of machines by running the following on each node
</span></span><span class="line"><span class="cl">as root:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  kubeadm join 192.168.10.21:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:564e3ba4b76649e981300fcea9e4400b759f91a02f4a968e035ada454f3a1d2e
</span></span></code></pre></td></tr></table>
</div>
</div><p>这段提示主要介绍了3点:</p>
<pre><code>1. 推荐非root账号使用`kubectl`命令。本文使用hall账号。
2. 需要在集群中创建pod network。本文使用flannel, 初始化命令中的`--pod-network-cidr=10.244.0.0/16`是使用flannel的必备参数，详情见官方英文文档。
3. 显示了其它节点加入集群的命令。
</code></pre>
<p>查看kubectl的版本信息:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ kubectl version
</span></span><span class="line"><span class="cl">Client Version: version.Info{Major:&#34;1&#34;, Minor:&#34;13&#34;, GitVersion:&#34;v1.13.0&#34;, GitCommit:&#34;ddf47ac13c1a9483ea035a79cd7c10005ff21a6d&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2018-12-03T21:04:45Z&#34;, GoVersion:&#34;go1.11.2&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}
</span></span><span class="line"><span class="cl">Server Version: version.Info{Major:&#34;1&#34;, Minor:&#34;13&#34;, GitVersion:&#34;v1.13.0&#34;, GitCommit:&#34;ddf47ac13c1a9483ea035a79cd7c10005ff21a6d&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2018-12-03T20:56:12Z&#34;, GoVersion:&#34;go1.11.2&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}
</span></span></code></pre></td></tr></table>
</div>
</div><p>查看节点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[hall@192-168-10-21 ~]$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME            STATUS     ROLES    AGE   VERSION
</span></span><span class="line"><span class="cl">192-168-10-21   NotReady   master   41m   v1.13.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里<strong>master</strong>的状态为<strong>NotReady</strong>是因为还没有进行pod network安装。</p>
<p>1.2 使用阿里云的docker hub镜像</p>
<p>如果网络ok，使用1.1的方法安装不会存在问题。但是国内可能一些镜像无法下载，可以使用阿里云的docker hub镜像进行安装。</p>
<p>首先输出<code>kubeadm</code>默认配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubeadm config print init-defaults &gt; kubeadm-init.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置内容大概如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">bootstrapTokens</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">groups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">system:bootstrappers:kubeadm:default-node-token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">token</span><span class="p">:</span><span class="w"> </span><span class="l">abcdef.0123456789abcdef</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">24h0m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">usages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">signing</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">authentication</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">InitConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">localAPIEndpoint</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">advertiseAddress</span><span class="p">:</span><span class="w"> </span><span class="m">1.2.3.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">bindPort</span><span class="p">:</span><span class="w"> </span><span class="m">6443</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">nodeRegistration</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">criSocket</span><span class="p">:</span><span class="w"> </span><span class="l">/var/run/dockershim.sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="m">192-168-10-21</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">taints</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="l">NoSchedule</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node-role.kubernetes.io/master</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiServer</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">timeoutForControlPlane</span><span class="p">:</span><span class="w"> </span><span class="l">4m0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kubeadm.k8s.io/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">certificatesDir</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/kubernetes/pki</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">clusterName</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controlPlaneEndpoint</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">controllerManager</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dns</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">CoreDNS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">etcd</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">dataDir</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/etcd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">imageRepository</span><span class="p">:</span><span class="w"> </span><span class="l">k8s.gcr.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterConfiguration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kubernetesVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1.13.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">networking</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">dnsDomain</span><span class="p">:</span><span class="w"> </span><span class="l">cluster.local</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">podSubnet</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">serviceSubnet</span><span class="p">:</span><span class="w"> </span><span class="m">10.244.0.0</span><span class="l">/16</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">scheduler</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：</p>
<ol>
<li>imageRepository修改成 registry.cn-hangzhou.aliyuncs.com/google_containers</li>
<li>serviceSubnet部分设置成10.244.0.0/16，也就是&ndash;pod-network-cidr=10.244.0.0/16参数。</li>
</ol>
</blockquote>
<p>然后先进行镜像下载:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubeadm config images pull --config kubeadm-init.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后再使用修改后的配置进行初始化:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">kubeadm init --config kubeadm-init.yaml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>也可以通过在每个节点得docker daemon.json 中配置镜像方式提速下载。</p>
</blockquote>
<ol start="2">
<li>work节点加入</li>
</ol>
<p>在work节点上执行kubeadm init完成后得到的join命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@192-168-10-18 ~]#kubeadm join 192.168.10.21:6443 --token abcdef.0123456789abcdef --discovery-token-ca-cert-hash sha256:564e3ba4b76649e981300fcea9e4400b759f91a02f4a968e035ada454f3a1d2e
</span></span></code></pre></td></tr></table>
</div>
</div><p>再次在master上查看节点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[hall@192-168-10-21 ~]$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME            STATUS     ROLES    AGE   VERSION
</span></span><span class="line"><span class="cl">192-168-10-18   NotReady   &lt;none&gt;   98s   v1.13.0
</span></span><span class="line"><span class="cl">192-168-10-21   NotReady   master   41m   v1.13.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到work节点<strong>192-168-10-18</strong>已经正常加入k8s集群了。</p>
<ol start="3">
<li>后期work节点加入</li>
</ol>
<p>如果join命令丢失或者过期，可以在master上执行下面命令,生成一个token:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">root@192-168-10-21 ~]# kubeadm token generate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">ffppwv.04qrmsdwm6netaaq</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后使用刚生成得token得到加入命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@192-168-10-21 ~]# kubeadm token create ffppwv.04qrmsdwm6netaaq --print-join-command --ttl=24h
</span></span><span class="line"><span class="cl">kubeadm join 192.168.10.21:6443 --token pnstpk.kk3aevbn6i5mlsok --discovery-token-ca-cert-hash sha256:5ae89f1949e60f824b129c5520dc05f6da97cb8fa3edb806c3abb38eb439e007
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<ol>
<li>&ndash;ttl=24h 代表这个Token 的有效期为 24 小时，初始化默认生成的 token 有效期也为 24 小时</li>
<li>join的语法是: <code>kubeadm join --token &lt;token&gt; &lt;master-ip&gt;:&lt;master-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</code></li>
</ol>
</blockquote>
<p>然后work节点使用这个命令加入集群。</p>
<ol start="4">
<li>安装flannel网络</li>
</ol>
<p>安装flannel网络很简单，分下面2步:</p>
<p>先下载yml文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">curl -O https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后创建flannel:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">kubectl create -f kube-flannel.yml</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>完成后可以检查:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="p">[</span><span class="l">hall@192-168-10-21 ~]$ kubectl get nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NAME            STATUS   ROLES    AGE    VERSION</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="m">192-168-10-18</span><span class="w">   </span><span class="l">Ready    &lt;none&gt;   102d   v1.13.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="m">192-168-10-21</span><span class="w">   </span><span class="l">Ready    master   102d   v1.13.0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这时候节点的状态应该是<strong>Ready</strong>。同时也可以查看flannel的pod：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[tyhall51@192-168-10-21 ~]$ kubectl get pods -n kube-system | grep flannel
</span></span><span class="line"><span class="cl">kube-flannel-ds-amd64-j7lxz             1/1     Running   1          102d
</span></span><span class="line"><span class="cl">kube-flannel-ds-amd64-lzjxg             1/1     Running   10         102d
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>删除节点</li>
</ol>
<p>删除节点可以使用:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubeclt delete node 192-168-10-18
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dashboard安装">Dashboard安装</h3>
<p>k8s完成后，可以使用 <code>kubectl</code> 进行所有控制。官方还提供了dashboard这种web界面，方便管理，一样分2步。</p>
<p>先下载配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -o kubernetes-dashboard.yaml  https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
</span></span><span class="line"><span class="cl">curl -o heapster.yaml https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml
</span></span><span class="line"><span class="cl">curl -o heapster-rbac.yaml https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml
</span></span><span class="line"><span class="cl">curl -o influxdb.yaml https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后创建:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> kubectl create -f kubernetes-dashboard.yaml 
</span></span><span class="line"><span class="cl"> kubectl create -f heapster.yaml 
</span></span><span class="line"><span class="cl"> kubectl create -f heapster-rbac.yaml 
</span></span><span class="line"><span class="cl"> kubectl create -f influxdb.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以使用<code>kubectl create -f .</code> 一键将目录下所有的yaml配置到k8s。</p>
<p>使用命令修改服务类型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n kube-system edit service kubernetes-dashboard
</span></span></code></pre></td></tr></table>
</div>
</div><p>修改 <strong>type: ClusterIP</strong> 成 <strong>type: NodePort</strong> 保存。 (kubectl edit 和vi一样操作)</p>
<blockquote>
<p>测试服务使用NodePort暴露到集群外，方便访问</p>
</blockquote>
<p>然后查看dashboard暴露出来的本地端口:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[hall@192-168-10-21 dashboard]$ kubectl -n kube-system get service kubernetes-dashboard
</span></span><span class="line"><span class="cl">NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE
</span></span><span class="line"><span class="cl">kubernetes-dashboard   NodePort   10.96.228.185   &lt;none&gt;        443:32145/TCP   6d21
</span></span></code></pre></td></tr></table>
</div>
</div><p>熟悉docker的就会知道，这里显示了dashboard容器的443端口映射到本地32145端口，然后我们使用<code>https://192.168.10.21:32145</code>访问.</p>
<p>访问需要token登录，下面是获取token的命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep eks-admin | awk &#39;{print $1}&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>效果如下:</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/3/26/169bab335d10e216?w=1920&amp;h=4015&amp;f=png&amp;s=806529" alt="preview"></p>
<h3 id="增加master节点">增加Master节点</h3>
<p>完成之前的内容，已经有一个初具规模的k8s集群了。如果要比较正式的集群，结合etcd的特性，控制节点多备，至少需要3台master节点。接下来继续介绍一下如何添加master节点。</p>
<p>使用命令 <code>kubectl -n kube-system edit cm kubeadm-config</code> 修改<strong>controlPlaneEndpoint</strong>值为<strong>192.168.10.21:6443</strong>，然后确认信息修改完成:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[hall@192-168-10-21 ~]$ kubectl -n kube-system get cm kubeadm-config -oyaml
</span></span><span class="line"><span class="cl">apiVersion: v1
</span></span><span class="line"><span class="cl">data:
</span></span><span class="line"><span class="cl">  ClusterConfiguration: |
</span></span><span class="line"><span class="cl">    apiServer:
</span></span><span class="line"><span class="cl">      extraArgs:
</span></span><span class="line"><span class="cl">        authorization-mode: Node,RBAC
</span></span><span class="line"><span class="cl">      timeoutForControlPlane: 4m0s
</span></span><span class="line"><span class="cl">    apiVersion: kubeadm.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">    certificatesDir: /etc/kubernetes/pki
</span></span><span class="line"><span class="cl">    clusterName: kubernetes
</span></span><span class="line"><span class="cl">    controlPlaneEndpoint: &#34;192.168.10.21:6443&#34;
</span></span><span class="line"><span class="cl">    controllerManager: {}
</span></span><span class="line"><span class="cl">    dns:
</span></span><span class="line"><span class="cl">      type: CoreDNS
</span></span><span class="line"><span class="cl">    etcd:
</span></span><span class="line"><span class="cl">      local:
</span></span><span class="line"><span class="cl">        dataDir: /var/lib/etcd
</span></span><span class="line"><span class="cl">    imageRepository: k8s.gcr.io
</span></span><span class="line"><span class="cl">    kind: ClusterConfiguration
</span></span><span class="line"><span class="cl">    kubernetesVersion: v1.13.0
</span></span><span class="line"><span class="cl">    networking:
</span></span><span class="line"><span class="cl">      dnsDomain: cluster.local
</span></span><span class="line"><span class="cl">      podSubnet: 10.244.0.0/16
</span></span><span class="line"><span class="cl">      serviceSubnet: 10.96.0.0/12
</span></span><span class="line"><span class="cl">    scheduler: {}
</span></span><span class="line"><span class="cl">  ClusterStatus: |
</span></span><span class="line"><span class="cl">    apiEndpoints:
</span></span><span class="line"><span class="cl">      192-168-10-21:
</span></span><span class="line"><span class="cl">        advertiseAddress: 192.168.10.21
</span></span><span class="line"><span class="cl">        bindPort: 6443
</span></span><span class="line"><span class="cl">    apiVersion: kubeadm.k8s.io/v1beta1
</span></span><span class="line"><span class="cl">    kind: ClusterStatus
</span></span><span class="line"><span class="cl">kind: ConfigMap
</span></span><span class="line"><span class="cl">metadata:
</span></span><span class="line"><span class="cl">  creationTimestamp: &#34;2018-12-14T03:12:12Z&#34;
</span></span><span class="line"><span class="cl">  name: kubeadm-config
</span></span><span class="line"><span class="cl">  namespace: kube-system
</span></span><span class="line"><span class="cl">  resourceVersion: &#34;13566522&#34;
</span></span><span class="line"><span class="cl">  selfLink: /api/v1/namespaces/kube-system/configmaps/kubeadm-config
</span></span><span class="line"><span class="cl">  uid: 0cf52c5b-ff4e-11e8-af11-000c2980069c
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这个ConfigMap就是之前kubeadm得config文件。</p>
</blockquote>
<p>复制第一个master节点上的相关证书到需要添加为master的<strong>192-168-10-14</strong>节点上，证书清单如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">/etc/kubernetes/pki/sa.key
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/sa.pub
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/ca.crt
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/ca.key
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/front-proxy-ca.crt
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/front-proxy-ca.key
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/etcd/ca.crt
</span></span><span class="line"><span class="cl">/etc/kubernetes/pki/etcd/ca.key
</span></span><span class="line"><span class="cl">/etc/kubernetes/admin.conf
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后在192-168-10-14上执行join命令，等待命令执行完成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubeadm join 192.168.10.21:6443 --token ffppwv.04qrmsdwm6netaaq --discovery-token-ca-cert-hash sha256:0cd1dcabee49dd12aaf7913eab9b0fc0e5bda2be9c35f17ce0c0864c7a5bbdb1  --experimental-control-plane
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个过程可能需要几分钟，期间kubectl会失效，耐心等待一下。</p>
<blockquote>
<p>注意:
比添加work节点多了 <strong>--experimental-control-plane</strong> 参数</p>
</blockquote>
<p>在第一个master节点执行 <code>kubectl label nodes 192-168-10-14 node-role.kubernetes.io/master=&quot;&quot;</code> ，标记 <strong>192-168-10-14</strong> 为master</p>
<p>检查一下节点情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[hall@192-168-10-21 ~]$ kubectl get nodes
</span></span><span class="line"><span class="cl">NAME            STATUS   ROLES    AGE    VERSION
</span></span><span class="line"><span class="cl">192-168-10-14   Ready    master   17m    v1.13.1
</span></span><span class="line"><span class="cl">192-168-10-18   Ready    &lt;none&gt;   102d   v1.13.0
</span></span><span class="line"><span class="cl">192-168-10-21   Ready    master   102d   v1.13.0
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后给 <strong>192-168-10-14</strong> 增加一个污点，标记为业务不可调度</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kubectl taint nodes 192-168-10-14 node-role.kubernetes.io/master=&#34;&#34;:NoSchedule
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样就完成了master节点的添加，可以重复步骤添加第3个master节点。如果是正式服务，要完成高可用，还需用HA代理3个master节点的6443端口。其实现过程主要就是HA的配置，这里就不在详细介绍了。</p>
<p>自此，一个测试用的k8s集群就搭建完成。简单总结一下搭建过程：</p>
<ol>
<li>按照官方要求进行环境监测和安装<strong>kubelet</strong>、<strong>kubeadm</strong>、<strong>kubectl</strong>三个包。</li>
<li>Master上初始化启动k8s集群，将节点加入集群和配置集群flannel网络。</li>
<li>安装dashboard，可视化管理集群。</li>
<li>增加master节点，支持高可以。</li>
</ol>
<h3 id="主要参考文档">主要参考文档</h3>
<p><a href="https://kubernetes.io/zh/docs/reference/setup-tools/kubeadm/kubeadm/">kubeadm安装</a></p>
<p><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">kubeadm init</a></p>
<p><a href="https://docs.aws.amazon.com/eks/latest/userguide/dashboard-tutorial.html">Deploy the Kubernetes Web UI (Dashboard)</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">shawn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-03-26
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%8C%87%E5%8D%97/">指南</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/kubernetes-1.14-upgrade-guide/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">kubernetes 1.14 升级指南</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/docker-log/">
            <span class="next-text nav-default">Docker容器日志分析</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '2019-03-26 23:27:54 \u002b0800 CST',
        title: 'kubernetes 1.13 安装指南',
        link: decodeURI(location.href),
        desc: 'kubernetes官方提供了中文文档，网上也有不少中文教程，可是实际的安装过程中，还是遇到了不少的坑。主要有： kubernetes的版本迭',
        owner: 'game404',
        repo: 'game404.github.io',
        oauth: {
          client_id: '28a86ccaa3184b49dfc4',
          client_secret: '15ab0f7c1445c0afb5e3d7a8995c89f2fd081eb7'
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:studyoo@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/game404" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/593f44b8da2f60006736604e" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://game404.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>game404</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137813525-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
