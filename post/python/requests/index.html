<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>requests 源码阅读 - 游戏不存在</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="shawn" /><meta name="description" content="requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我" /><meta name="keywords" content="game, docker, kubernetes, python, go,  microservice" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://game404.github.io/post/python/requests/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="requests 源码阅读" />
<meta property="og:description" content="requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://game404.github.io/post/python/requests/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-01-17T08:31:48+08:00" />
<meta property="article:modified_time" content="2021-01-17T08:31:48+08:00" />

<meta itemprop="name" content="requests 源码阅读">
<meta itemprop="description" content="requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我"><meta itemprop="datePublished" content="2021-01-17T08:31:48+08:00" />
<meta itemprop="dateModified" content="2021-01-17T08:31:48+08:00" />
<meta itemprop="wordCount" content="3722">
<meta itemprop="keywords" content="http,源码," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="requests 源码阅读"/>
<meta name="twitter:description" content="requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">游戏不存在</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">游戏不存在</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">requests 源码阅读</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-17 </span>
        <div class="post-category">
            <a href="/categories/python/"> python </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#项目结构">项目结构</a></li>
    <li><a href="#api-模块">api 模块</a></li>
    <li><a href="#sessions">sessions</a></li>
    <li><a href="#models">models</a></li>
    <li><a href="#adapters-模块">adapters 模块</a></li>
    <li><a href="#小技巧">小技巧</a>
      <ul>
        <li><a href="#json缩进输出">json缩进输出</a></li>
        <li><a href="#structures">structures</a></li>
        <li><a href="#status_codes">status_codes</a></li>
        <li><a href="#hook">hook</a></li>
      </ul>
    </li>
    <li><a href="#参考链接">参考链接</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我个人觉得还是官方的地道：
<code>Requests is an elegant and simple HTTP library for Python, built for human beings.</code> 夸张到是人类就会使用requests :)。我们一起阅读一下其源码，学习它是如何实现的。整篇文档分下面几个部分:</p>
<ul>
<li>项目结构</li>
<li>api 模块</li>
<li>sessions 模块</li>
<li>models 模块</li>
<li>adapters 模块</li>
<li>小技巧</li>
</ul>
<h2 id="项目结构">项目结构</h2>
<p>本次阅读代码版本是 <code>2.24.0</code>, 从github上clone项目后，使用log命令查看历史信息，找到tag=2.24.0的标签，切换版本:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git checkout 0797c61fd541f92f66e409dbf9515ca287af28d2
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以使用下面的方法简单判断一下代码量，这样阅读完成后会更有成就感。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">➜  requests git:(0797c61f) ✗ find requests -name &#34;*.py&#34; |xargs cat|grep -v ^$|wc -l  # 4000
</span></span></code></pre></td></tr></table>
</div>
</div><p>大概浏览一下项目结构和代码，我们可以知道每个模块的功能：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>adapters.py</td>
<td>负责http连接的处理，主要适配自urllib3库</td>
</tr>
<tr>
<td>api</td>
<td>api接口</td>
</tr>
<tr>
<td>auth</td>
<td>http认证</td>
</tr>
<tr>
<td>certs</td>
<td>https证书处理</td>
</tr>
<tr>
<td>compat</td>
<td>python版本适配包</td>
</tr>
<tr>
<td>cookies</td>
<td>cookie处理</td>
</tr>
<tr>
<td>help</td>
<td>帮助</td>
</tr>
<tr>
<td>hook</td>
<td>钩子系统</td>
</tr>
<tr>
<td>models</td>
<td>数据模型</td>
</tr>
<tr>
<td>packages</td>
<td>兼容包相关</td>
</tr>
<tr>
<td>sessions</td>
<td>session处理</td>
</tr>
<tr>
<td>status_codes</td>
<td>http状态码</td>
</tr>
<tr>
<td>structures</td>
<td>数据结构</td>
</tr>
<tr>
<td>utils</td>
<td>工具</td>
</tr>
</tbody>
</table>
<p>4000多行代码，10多个模块，要全部梳理工作量不小，难度也大。本篇文章我们还是只关注主线，对于支线和细枝末节可以 <strong>不求甚解</strong> 。</p>
<h2 id="api-模块">api 模块</h2>
<p>首先还是从requests的使用示例出发：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt;&gt;&gt; r = requests.get(&#39;https://api.github.com/user&#39;, auth=(&#39;user&#39;, &#39;pass&#39;))
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; r.status_code
</span></span><span class="line"><span class="cl">200
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; r.headers[&#39;content-type&#39;]
</span></span><span class="line"><span class="cl">&#39;application/json; charset=utf8&#39;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; r.encoding
</span></span><span class="line"><span class="cl">&#39;utf-8&#39;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; r.text
</span></span><span class="line"><span class="cl">&#39;{&#34;type&#34;:&#34;User&#34;...&#39;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; r.json()
</span></span><span class="line"><span class="cl">{&#39;private_gists&#39;: 419, &#39;total_private_repos&#39;: 77, ...}
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的使用方法由api提供:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># api.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def request(method, url, **kwargs)
</span></span><span class="line"><span class="cl">    with sessions.Session() as session:
</span></span><span class="line"><span class="cl">        return session.request(method=method, url=url, **kwargs)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get(url, params=None, **kwargs):
</span></span><span class="line"><span class="cl">    kwargs.setdefault(&#39;allow_redirects&#39;, True)
</span></span><span class="line"><span class="cl">    return request(&#39;get&#39;, url, params=params, **kwargs)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种get-request的api的封装方式，和我们之前读过的redis源码类似，可以让使用者更安全方便。request具体实现代码是从session上下文获取一个session，然后利用 <strong>session.request</strong> 发送请求。</p>
<p>同时api中还包装了http的 <code>OPTIONS</code>, <code>HEAD</code>, <code>POST</code>, <code>PUT</code>, <code>PATCH</code> 和<code>DELETE</code> 方法。</p>
<h2 id="sessions">sessions</h2>
<p><code>sessions.py</code> 对象的创建和上下文：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># sessions.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Session(SessionRedirectMixin):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self):
</span></span><span class="line"><span class="cl">        self.headers = default_headers()
</span></span><span class="line"><span class="cl">        self.cookies = cookiejar_from_dict({})
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        # Default connection adapters.
</span></span><span class="line"><span class="cl">        self.adapters = OrderedDict()
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self.mount(&#39;https://&#39;, HTTPAdapter())
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def mount(self, prefix, adapter):
</span></span><span class="line"><span class="cl">        self.adapters[prefix] = adapter
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    def __enter__(self):
</span></span><span class="line"><span class="cl">        return self
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __exit__(self, *args):
</span></span><span class="line"><span class="cl">        for v in self.adapters.values():
</span></span><span class="line"><span class="cl">            v.close()
</span></span></code></pre></td></tr></table>
</div>
</div><p>session初始化时候，会创建默认的http-header，http-cookie信息，建立HTTPAdpater对象。<code>__enter__</code>和<code>__exit__</code>,是上下文装饰器函数，可以用来确保进行adapter的close。</p>
<p>使用request方法发送请求:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def request(self, method, url,
</span></span><span class="line"><span class="cl">        params=None, data=None, headers=None, cookies=None, files=None,
</span></span><span class="line"><span class="cl">        auth=None, timeout=None, allow_redirects=True, proxies=None,
</span></span><span class="line"><span class="cl">        hooks=None, stream=None, verify=None, cert=None, json=None):
</span></span><span class="line"><span class="cl">    req = Request(
</span></span><span class="line"><span class="cl">        method=method.upper(),
</span></span><span class="line"><span class="cl">        url=url,
</span></span><span class="line"><span class="cl">        headers=headers,
</span></span><span class="line"><span class="cl">        files=files,
</span></span><span class="line"><span class="cl">        data=data or {},
</span></span><span class="line"><span class="cl">        json=json,
</span></span><span class="line"><span class="cl">        params=params or {},
</span></span><span class="line"><span class="cl">        auth=auth,
</span></span><span class="line"><span class="cl">        cookies=cookies,
</span></span><span class="line"><span class="cl">        hooks=hooks,
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    prep = PreparedRequest()
</span></span><span class="line"><span class="cl">    prep.prepare(
</span></span><span class="line"><span class="cl">        method=request.method.upper(),
</span></span><span class="line"><span class="cl">        url=request.url,
</span></span><span class="line"><span class="cl">        files=request.files,
</span></span><span class="line"><span class="cl">        data=request.data,
</span></span><span class="line"><span class="cl">        json=request.json,
</span></span><span class="line"><span class="cl">        headers=merge_setting(request.headers, self.headers, dict_class=CaseInsensitiveDict),
</span></span><span class="line"><span class="cl">        params=merge_setting(request.params, self.params),
</span></span><span class="line"><span class="cl">        auth=merge_setting(auth, self.auth),
</span></span><span class="line"><span class="cl">        cookies=merged_cookies,
</span></span><span class="line"><span class="cl">        hooks=merge_hooks(request.hooks, self.hooks),
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    adapter = self.get_adapter(url=request.url)
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    resp = adapter.send(prep, **send_kwargs)
</span></span><span class="line"><span class="cl">    return resp
</span></span></code></pre></td></tr></table>
</div>
</div><p>request函数的处理流程，主要分成四步：</p>
<ol>
<li>使用请求参数封装Request对象</li>
<li>生成PreparedRequest对象，并对request对象进行预先处理</li>
<li>获取对应的http/https协议适配器，并用其send方法发送请求</li>
<li>将获取的Response对象返回</li>
</ol>
<h2 id="models">models</h2>
<p>在进行请求过程中创建了Request，PreparedRequest对象，同时从adpater中返回了Response对象,这3个对象的具体实现都在 <code>models.py</code> 模块。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Request(RequestHooksMixin):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self,
</span></span><span class="line"><span class="cl">            method=None, url=None, headers=None, files=None, data=None,
</span></span><span class="line"><span class="cl">            params=None, auth=None, cookies=None, hooks=None, json=None):
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self.hooks = default_hooks()
</span></span><span class="line"><span class="cl">        for (k, v) in list(hooks.items()):
</span></span><span class="line"><span class="cl">            self.register_hook(event=k, hook=v)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        self.method = method
</span></span><span class="line"><span class="cl">        self.url = url
</span></span><span class="line"><span class="cl">        self.headers = headers
</span></span><span class="line"><span class="cl">        self.files = files
</span></span><span class="line"><span class="cl">        self.data = data
</span></span><span class="line"><span class="cl">        self.json = json
</span></span><span class="line"><span class="cl">        self.params = params
</span></span><span class="line"><span class="cl">        self.auth = auth
</span></span><span class="line"><span class="cl">        self.cookies = cookies
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>Request对象创建比较简单，就是做了一些属性的赋值，然后对外部注入的hook进行了一下校验，确保是可以执行的函数和函数集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def register_hook(self, event, hook):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Properly register a hook.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if event not in self.hooks:
</span></span><span class="line"><span class="cl">        raise ValueError(&#39;Unsupported event specified, with event name &#34;%s&#34;&#39; % (event))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if isinstance(hook, Callable):  ## hook 是一个函数
</span></span><span class="line"><span class="cl">        self.hooks[event].append(hook)
</span></span><span class="line"><span class="cl">    elif hasattr(hook, &#39;__iter__&#39;):  # hook 也可以是一个迭代器
</span></span><span class="line"><span class="cl">        self.hooks[event].extend(h for h in hook if isinstance(h, Callable))
</span></span></code></pre></td></tr></table>
</div>
</div><p>PreparedRequest对象则对外部的参数进行更多的验证和准备:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def prepare(self,
</span></span><span class="line"><span class="cl">        method=None, url=None, headers=None, files=None, data=None,
</span></span><span class="line"><span class="cl">        params=None, auth=None, cookies=None, hooks=None, json=None):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Prepares the entire request with the given parameters.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        self.prepare_method(method)
</span></span><span class="line"><span class="cl">        self.prepare_url(url, params)
</span></span><span class="line"><span class="cl">        self.prepare_headers(headers)
</span></span><span class="line"><span class="cl">        self.prepare_cookies(cookies)
</span></span><span class="line"><span class="cl">        self.prepare_body(data, files, json)
</span></span><span class="line"><span class="cl">        self.prepare_auth(auth, url)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        hooks = hooks or []
</span></span><span class="line"><span class="cl">        for event in hooks:
</span></span><span class="line"><span class="cl">            self.register_hook(event, hooks[event])
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到PreparedRequest对象经过了：</p>
<ul>
<li>准备http方法</li>
<li>准备url</li>
<li>准备header</li>
<li>准备cookie</li>
<li>准备http-body</li>
<li>准备认证</li>
<li>接受Request对象上带来的hook</li>
</ul>
<p>hook我们最后再进行详细介绍，这里以prepare_headers为例看看验证过程中都做了什么:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def prepare_headers(self, headers):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Prepares the given HTTP headers.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    self.headers = CaseInsensitiveDict()  # 创建字典 
</span></span><span class="line"><span class="cl">    if headers:
</span></span><span class="line"><span class="cl">        for header in headers.items():
</span></span><span class="line"><span class="cl">            # Raise exception on invalid header value.
</span></span><span class="line"><span class="cl">            check_header_validity(header) # 验证信息
</span></span><span class="line"><span class="cl">            name, value = header
</span></span><span class="line"><span class="cl">            self.headers[to_native_string(name)] = value  # 赋值
</span></span></code></pre></td></tr></table>
</div>
</div><p>Response对象，主要模拟文件操作，raw保留了二进制数据流，content属性是获得所有二进制数据，text属性将二进制数据编码成文本，json方法则是将文本序列化方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">CONTENT_CHUNK_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="c1"># 10k数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">class</span><span class="w"> </span><span class="nf">Response</span><span class="p">(</span><span class="n">object</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">#: File-like object representation of response (for advanced usage).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">#: Use of ``raw`` requires that ``stream=True`` be set on the request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="c1">#: This requirement does not apply for use internally to Requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">property</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">content</span><span class="p">(</span><span class="n">self</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s2">&#34;&#34;&#34;Content of the response, in bytes.&#34;&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">_content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="k">join</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">iter_content</span><span class="p">(</span><span class="n">CONTENT_CHUNK_SIZE</span><span class="p">))</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">b</span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_content</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">property</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="n">self</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">str</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">encoding</span><span class="p">,</span><span class="w"> </span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">content</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">def</span><span class="w"> </span><span class="nf">json</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">complexjson</span><span class="p">.</span><span class="nf">loads</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="kt">text</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>requests 优先使用simplejson进行json的序列化</p>
</blockquote>
<p><code>iter_content</code> 函数中使用一个生成器来迭代的从流中获取数据。至于流如何得到，稍后看adapter的实现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def iter_content(self, chunk_size=1, decode_unicode=False):
</span></span><span class="line"><span class="cl">    def generate():
</span></span><span class="line"><span class="cl">            # Special case for urllib3.
</span></span><span class="line"><span class="cl">            if hasattr(self.raw, &#39;stream&#39;):
</span></span><span class="line"><span class="cl">                try:
</span></span><span class="line"><span class="cl">                    for chunk in self.raw.stream(chunk_size, decode_content=True):
</span></span><span class="line"><span class="cl">                        yield chunk
</span></span><span class="line"><span class="cl">    stream_chunks = generate()
</span></span><span class="line"><span class="cl">    return stream_chunks
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="adapters-模块">adapters 模块</h2>
<p>具体的http请求如何发送的呢？主要就在HTTPAdapter中了:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class HTTPAdapter(BaseAdapter):
</span></span><span class="line"><span class="cl">    def __init__(self, pool_connections=DEFAULT_POOLSIZE,
</span></span><span class="line"><span class="cl">                 pool_maxsize=DEFAULT_POOLSIZE, max_retries=DEFAULT_RETRIES,
</span></span><span class="line"><span class="cl">                 pool_block=DEFAULT_POOLBLOCK):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        # 初始化连接池
</span></span><span class="line"><span class="cl">        self.poolmanager = PoolManager(num_pools=connections, maxsize=maxsize,
</span></span><span class="line"><span class="cl">                                       block=block, strict=True, **pool_kwargs)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def send(self, request, stream=False, timeout=None, verify=True, cert=None, proxies=None):
</span></span><span class="line"><span class="cl">        conn = self.poolmanager.connection_from_url(url) # 获取连接
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        url = self.request_url(request, proxies)
</span></span><span class="line"><span class="cl">        self.add_headers(request, stream=stream, timeout=timeout, verify=verify, cert=cert, proxies=proxies)
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        # 发送请求
</span></span><span class="line"><span class="cl">        resp = conn.urlopen(
</span></span><span class="line"><span class="cl">                    method=request.method,
</span></span><span class="line"><span class="cl">                    url=url,
</span></span><span class="line"><span class="cl">                    body=request.body,
</span></span><span class="line"><span class="cl">                    headers=request.headers,
</span></span><span class="line"><span class="cl">                    redirect=False,
</span></span><span class="line"><span class="cl">                    assert_same_host=False,
</span></span><span class="line"><span class="cl">                    preload_content=False,
</span></span><span class="line"><span class="cl">                    decode_content=False,
</span></span><span class="line"><span class="cl">                    retries=self.max_retries,
</span></span><span class="line"><span class="cl">                    timeout=timeout
</span></span><span class="line"><span class="cl">                )
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        return self.build_response(request, resp)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def close(self):
</span></span><span class="line"><span class="cl">        self.poolmanager.clear()  # 连接池关闭
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里主要用了urllib3库提供的PoolManager和urlopen，本篇文章我们就不深入里面的实现了，重点看看如何生成Response对象:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def build_response(self, req, resp):
</span></span><span class="line"><span class="cl">    response = Response()
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    # Fallback to None if there&#39;s no status_code, for whatever reason.
</span></span><span class="line"><span class="cl">    response.status_code = getattr(resp, &#39;status&#39;, None)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # Make headers case-insensitive.
</span></span><span class="line"><span class="cl">    response.headers = CaseInsensitiveDict(getattr(resp, &#39;headers&#39;, {}))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # Set encoding.
</span></span><span class="line"><span class="cl">    response.encoding = get_encoding_from_headers(response.headers)
</span></span><span class="line"><span class="cl">    response.raw = resp  # 二进制流
</span></span><span class="line"><span class="cl">    response.reason = response.raw.reason
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if isinstance(req.url, bytes):
</span></span><span class="line"><span class="cl">        response.url = req.url.decode(&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">    else:
</span></span><span class="line"><span class="cl">        response.url = req.url
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # Add new cookies from the server.
</span></span><span class="line"><span class="cl">    extract_cookies_to_jar(response.cookies, req, resp)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # Give the Response some context.
</span></span><span class="line"><span class="cl">    response.request = req
</span></span><span class="line"><span class="cl">    response.connection = self
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return response
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>resp 是urllib3的HTTPResponse实现</li>
<li>cookie是合并了Request和Response</li>
<li>Response还引用了PreparedRequest对象，可以让response的使用更方便</li>
</ul>
<p>使用requests进行http请求的过程，主要集中在上面四个模块，现在对其核心过程都有了一定的了解。https则是再http基础上，做了更多的验证等工作。可以简单回顾一下请求执行流程：</p>
<ol>
<li>api中封装易用的API</li>
<li>Session中进行流程的处理</li>
<li>Request和PreparedRequest对请求进行预处理</li>
<li>Response对响应进行封装，提供更易用的方法(json)和数据(ok)</li>
</ol>
<h2 id="小技巧">小技巧</h2>
<p>requests库中还有一些代码，也让使用更简单，可以借鉴。</p>
<h3 id="json缩进输出">json缩进输出</h3>
<p>json输出的时候定义indent参数可以进行缩进，sort_keys可以进行排序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># help.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&#34;&#34;&#34;Pretty-print the bug information as JSON.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">print(json.dumps(info(), sort_keys=True, indent=2))
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面是示例和展示:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a = {
</span></span><span class="line"><span class="cl">        &#34;name&#34;: &#34;game404&#34;,
</span></span><span class="line"><span class="cl">        &#34;age&#34;: 2
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">print(json.dumps(a)) 
</span></span><span class="line"><span class="cl">print(json.dumps(a, sort_keys=True, indent=2))  # 定义indent参数
</span></span><span class="line"><span class="cl"># 输出
</span></span><span class="line"><span class="cl">{&#34;name&#34;: &#34;game404&#34;, &#34;age&#34;: 2}
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">  &#34;age&#34;: 2,
</span></span><span class="line"><span class="cl">  &#34;name&#34;: &#34;game404&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="structures">structures</h3>
<p>structures模块中定义了2个数据结构。普通的python字典不可以使用 <code>.</code> 取值, 如果需要使用 <code>.</code> 需要定义对象:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># structures.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">a = {
</span></span><span class="line"><span class="cl">    &#34;name&#34;:&#34;game404&#34;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl"># print(a.name)  # AttributeError
</span></span><span class="line"><span class="cl">print(a[&#34;name&#34;])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 定义一个数据结构对象
</span></span><span class="line"><span class="cl">class Person(object):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self, name):
</span></span><span class="line"><span class="cl">        self.name = name
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>LookupDict</code> 可以不用定义对象属性又使用<code>.</code> 取值，这在一些配置类上会很方便:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class LookupDict(dict):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Dictionary lookup object.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self, name=None):
</span></span><span class="line"><span class="cl">        self.name = name
</span></span><span class="line"><span class="cl">        super(LookupDict, self).__init__()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __repr__(self):
</span></span><span class="line"><span class="cl">        return &#39;&lt;lookup \&#39;%s\&#39;&gt;&#39; % (self.name)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __getitem__(self, key):
</span></span><span class="line"><span class="cl">        # We allow fall-through here, so values default to None
</span></span><span class="line"><span class="cl">        # 可以使用. 取值的魔法函数
</span></span><span class="line"><span class="cl">        return self.__dict__.get(key, None)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def get(self, key, default=None):
</span></span><span class="line"><span class="cl">        return self.__dict__.get(key, default
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">a = LookupDict(name=&#34;game404&#34;)
</span></span><span class="line"><span class="cl">a[&#34;motto&#34;] = &#34;Life is short, you need Python&#34;
</span></span><span class="line"><span class="cl">a.age = 2
</span></span><span class="line"><span class="cl">print(a[&#34;motto&#34;], a.age, a[&#34;age&#34;])  # none, 2, 2
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>CaseInsensitiveDict</code> 定义了大小写不敏感的字典，用来处理http-header：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class CaseInsensitiveDict(MutableMapping):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self, data=None, **kwargs):
</span></span><span class="line"><span class="cl">        self._store = OrderedDict()  # 使用额外的_store存储数据
</span></span><span class="line"><span class="cl">        if data is None:
</span></span><span class="line"><span class="cl">            data = {}
</span></span><span class="line"><span class="cl">        self.update(data, **kwargs)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __setitem__(self, key, value):
</span></span><span class="line"><span class="cl">        # Use the lowercased key for lookups, but store the actual
</span></span><span class="line"><span class="cl">        # key alongside the value.
</span></span><span class="line"><span class="cl">        self._store[key.lower()] = (key, value)  # 字典的key都转换为小写 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __delitem__(self, key):
</span></span><span class="line"><span class="cl">        del self._store[key.lower()]
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">cid = CaseInsensitiveDict()
</span></span><span class="line"><span class="cl">cid[&#39;Accept&#39;] = &#39;application/json&#39;
</span></span><span class="line"><span class="cl">print(cid[&#39;aCCEPT&#39;] == &#39;application/json&#39;)  # True
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到CaseInsensitiveDict对象的__dict__实际上使用_store包装了一层:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">print(cid.__dict__)  # {&#39;_store&#39;: OrderedDict([(&#39;accept&#39;, (&#39;Accept&#39;, &#39;application/json&#39;))])} 
</span></span><span class="line"><span class="cl">print(cid._store)  # OrderedDict([(&#39;accept&#39;, (&#39;Accept&#39;, &#39;application/json&#39;))])
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="status_codes">status_codes</h3>
<p>status_codes中定义了http状态码的语义化名称，比如 <code>OK</code> 是 <code>200</code>的语义化表达，不懂http的人也可以看到ok状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">print(requests.codes[&#34;ok&#34;], requests.codes.OK, requests.codes.ok, requests.codes.OKAY)  #200 200 200 200
</span></span><span class="line"><span class="cl">print(requests.codes.CREATED)  # 201
</span></span><span class="line"><span class="cl">print(requests.codes.found)  # 302
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实现方法主要是:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># statuc_codes.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">codes = LookupDict(name=&#39;status_codes&#39;)
</span></span><span class="line"><span class="cl">for code, titles in _codes.items():
</span></span><span class="line"><span class="cl">        for title in titles:
</span></span><span class="line"><span class="cl">            setattr(codes, title, code)  # 默认key 
</span></span><span class="line"><span class="cl">            if not title.startswith((&#39;\\&#39;, &#39;/&#39;)):
</span></span><span class="line"><span class="cl">                setattr(codes, title.upper(), code)  # 大写key
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="hook">hook</h3>
<p><code>hooks</code> 提供了一个简单的钩子系统，可以对一个事件名称注册多个处理函数（前面的register_hook），然后在合适的时候触发就可以获取对数据进行处理， 数据处理过程类似linux的管道符号 <code>|</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># hooks.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HOOKS = [&#39;response&#39;]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def default_hooks():  # 初始化默认的事件
</span></span><span class="line"><span class="cl">    return {event: [] for event in HOOKS}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def dispatch_hook(key, hooks, hook_data, **kwargs):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Dispatches a hook dictionary on a given piece of data.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    hooks = hooks or {}
</span></span><span class="line"><span class="cl">    hooks = hooks.get(key)
</span></span><span class="line"><span class="cl">    if hooks:
</span></span><span class="line"><span class="cl">        if hasattr(hooks, &#39;__call__&#39;):  # 判断是函数还是函数集合
</span></span><span class="line"><span class="cl">            hooks = [hooks]
</span></span><span class="line"><span class="cl">        for hook in hooks:
</span></span><span class="line"><span class="cl">            _hook_data = hook(hook_data, **kwargs)  # 注意hook会返回数据，由下一个函数继续处理
</span></span><span class="line"><span class="cl">            if _hook_data is not None:
</span></span><span class="line"><span class="cl">                hook_data = _hook_data
</span></span><span class="line"><span class="cl">    return hook_data
</span></span></code></pre></td></tr></table>
</div>
</div><p>使用方法在:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Session(SessionRedirectMixin):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def send(self, request, **kwargs):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        r = adapter.send(request, **kwargs)
</span></span><span class="line"><span class="cl">        # Response manipulation hooks
</span></span><span class="line"><span class="cl">        r = dispatch_hook(&#39;response&#39;, hooks, r, **kwargs)
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></td></tr></table>
</div>
</div><p>session在获取到请求后，触发预先定义的钩子，对response进行进一步的处理。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://requests.readthedocs.io/zh_CN/latest/">https://requests.readthedocs.io/zh_CN/latest/</a></li>
<li><a href="https://urllib3.readthedocs.io/en/latest/">https://urllib3.readthedocs.io/en/latest/</a></li>
<li><a href="https://gist.github.com/kennethreitz42/973705">https://gist.github.com/kennethreitz42/973705</a></li>
</ul>
<p>最后，欢迎加下面的微信和我互动交流，一起进阶:
<img src="https://game404-1251284600.cos.ap-beijing.myqcloud.com/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E7%99%BD%E8%89%B2%E7%89%88.png" alt="wx"></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">shawn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-01-17
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/http/">http</a>
          <a href="/tags/%E6%BA%90%E7%A0%81/">源码</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/python/bottle/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Bottle 源码阅读</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/python/redis-py/">
            <span class="next-text nav-default">Redis-py 源码阅读</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '2021-01-17 08:31:48 \u002b0800 CST',
        title: 'requests 源码阅读',
        link: decodeURI(location.href),
        desc: 'requests是一个简洁易用的http-client库，早期在github的python项目受欢迎程度可以排名TOP10。介绍这个项目，我',
        owner: 'game404',
        repo: 'game404.github.io',
        oauth: {
          client_id: '28a86ccaa3184b49dfc4',
          client_secret: '15ab0f7c1445c0afb5e3d7a8995c89f2fd081eb7'
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:studyoo@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/game404" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/593f44b8da2f60006736604e" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://game404.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>game404</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137813525-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
