<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>神器 celery 源码解析 - 3 - 游戏不存在</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="shawn" /><meta name="description" content="kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。 Celery是一款非常简单、灵活、" /><meta name="keywords" content="game, docker, kubernetes, python, go,  microservice" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://game404.github.io/post/python/celery-3/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="神器 celery 源码解析 - 3" />
<meta property="og:description" content="kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。 Celery是一款非常简单、灵活、" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://game404.github.io/post/python/celery-3/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-25T21:19:23+08:00" />
<meta property="article:modified_time" content="2021-10-25T21:19:23+08:00" />

<meta itemprop="name" content="神器 celery 源码解析 - 3">
<meta itemprop="description" content="kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。 Celery是一款非常简单、灵活、"><meta itemprop="datePublished" content="2021-10-25T21:19:23+08:00" />
<meta itemprop="dateModified" content="2021-10-25T21:19:23+08:00" />
<meta itemprop="wordCount" content="7692">
<meta itemprop="keywords" content="celery,源码," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="神器 celery 源码解析 - 3"/>
<meta name="twitter:description" content="kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。 Celery是一款非常简单、灵活、"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">游戏不存在</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">游戏不存在</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">神器 celery 源码解析 - 3</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-25 </span>
        <div class="post-category">
            <a href="/categories/python/"> python </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#amqp-概念">AMQP 概念</a></li>
    <li><a href="#kombu概述">kombu概述</a></li>
    <li><a href="#kombu-使用指南">kombu 使用指南</a></li>
    <li><a href="#producer--consumer-解析">Producer &amp;&amp; Consumer 解析</a>
      <ul>
        <li><a href="#proudcer解析">Proudcer解析</a></li>
        <li><a href="#consumer解析">Consumer解析</a></li>
      </ul>
    </li>
    <li><a href="#exchange--queue-解析">Exchange &amp;&amp; Queue 解析</a></li>
    <li><a href="#message-解析">Message 解析</a></li>
    <li><a href="#connection-解析">Connection 解析</a></li>
    <li><a href="#matcher--serialization">Matcher &amp;&amp; serialization</a></li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#小技巧">小技巧</a>
      <ul>
        <li><a href="#pickle打包函数">pickle打包函数</a></li>
        <li><a href="#配置类的简化">配置类的简化</a></li>
        <li><a href="#使用count提供自增id">使用count提供自增ID</a></li>
      </ul>
    </li>
    <li><a href="#参考连接">参考连接</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。</p>
<p>Celery是一款非常简单、灵活、可靠的分布式系统，可用于处理大量消息，并且提供了一整套操作此系统的工具。Celery 也是一款消息队列工具，可用于处理实时数据以及任务调度。</p>
<p>本文是是celery源码解析的第三篇，在前两篇里分别介绍了vine和py-amqp:</p>
<ol>
<li><a href="https://game404.github.io/post/python/celery-1/">神器 celery 源码解析- vine实现Promise功能</a></li>
<li><a href="https://game404.github.io/post/python/celery-2/">神器 celery 源码解析- py-amqp实现AMQP协议</a></li>
</ol>
<p>本文包括下面几个部分:</p>
<ul>
<li>AMQP协议</li>
<li>kombu概述</li>
<li>kombu使用指南</li>
<li>Producer &amp;&amp; Consumer 解析</li>
<li>Exchange &amp;&amp; Queue 解析</li>
<li>Message 解析</li>
<li>Connection 解析</li>
<li>Matcher &amp;&amp; serialization</li>
<li>小结</li>
<li>小技巧</li>
</ul>
<h2 id="amqp-概念">AMQP 概念</h2>
<p>接上篇，我们继续学习AMQP的相关概念。理解这些基础概念对kombu为什么这样实现很有帮助。这次我们用小故事来模拟kombu的消息处理流程。</p>
<p>小学三年级的小明同学喜欢同桌的小红同学，喜欢她的马尾和笑容，经常写小纸条给她。这里小纸条就是Message，小明同学是Producer, 小红同学是Consumer，这种直接投递的方式是direct。有时候，小红同学不在座位上，小明就把纸条放在她的抽屉里。抽屉就当做Queue使用，临时存放投递的消息。老师发现小明和小红上课经常有小动作后，棒打鸳鸯把他们分开了，他们不再是同桌。小明同学没法忘记小红的笑容，距离产生了更多的美，就拜托前面的小马帮他递小纸条，纸条封面上写着“请给小红”。小马就是Exchange，小马的前座也是Exchange，“请给小红”就是消息的route-key。常在河边走，哪有不湿脚。有次纸条被老师抓住，老师让小明同学在讲台上把纸条的内容讲给大家听。当众念小纸条这叫广播, 也就是fanout。</p>
<p>幼稚的小故事也是一种真实的生活，谁又没有写过小纸条呢，请暂停回忆一分钟:) 。 业务是生活场景的一种抽象，代码又是更高层一点的抽象。理解业务，就对代码上的概念不发楞。</p>
<p>以上这些概念Exchange，Queue都是broker要实现的内容。可是客户端Producer/Consumer也包含，这是为什么呢？消息传输过程可不可以简化成一个客户端只使用producer发送消息，另外一个客户端只使用consumer消费消息呢？这样也不是不行，前提是AMQP协议中exchange和queue的创建及绑定，需要使用管理工具在broker先创建好，这无疑约束了AMPQ使用的灵活性。kombu中包含了Exchange，Queue模型，主要是用来对broker的管理。</p>
<h2 id="kombu概述">kombu概述</h2>
<p>kombu是植物家族的重要一员, 芹菜(celery)、葡萄藤(vine)、海带(kombu)是快乐的一家人。我们解析kombu，采用的版本是 <code>5.0.0</code>, 主要模块如下:</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>abstract.py</td>
<td>抽象的绑定实现，对象是否可以绑定到channel</td>
</tr>
<tr>
<td>compression.py</td>
<td>压缩算法的汇总</td>
</tr>
<tr>
<td>connection.py</td>
<td>broker的连接</td>
</tr>
<tr>
<td>entity.py</td>
<td>实体类，包括Exchange，binding和Queue对象的实现</td>
</tr>
<tr>
<td>matcher.py</td>
<td>匹配策略</td>
</tr>
<tr>
<td>message.py</td>
<td>消息对象,并且附带消息的操作接口ack，reject等</td>
</tr>
<tr>
<td>messaging.py</td>
<td>消息处理，包括Producer和Consumer</td>
</tr>
<tr>
<td>mixins.py,pools.py,simple.py</td>
<td>增强功能或者提升便捷使用的封装</td>
</tr>
<tr>
<td>serialization.py</td>
<td>序列化算法的汇总</td>
</tr>
<tr>
<td>transport</td>
<td>对接各种存储引擎的数据传输实现，主要有内存，redis，pyamqp(RabbitMQ) 等</td>
</tr>
<tr>
<td>asynchronous</td>
<td>异步实现</td>
</tr>
</tbody>
</table>
<p>kombu底层使用pyamqp提供的AMQP协议支持，并完成Producer，Consumer，Exchange，Queue等模型实现。</p>
<h2 id="kombu-使用指南">kombu 使用指南</h2>
<p>老规矩，先从kombu的使用开始。下面是一个生产者发送消息的示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># kombu-5.0.0/examples/complete_send.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from kombu import Connection, Producer, Exchange, Queue
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">exchange = Exchange(&#39;kombu_demo&#39;, type=&#39;direct&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">with Connection(&#39;amqp://guest:guest@localhost:5672//&#39;) as connection:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    producer = Producer(connection)
</span></span><span class="line"><span class="cl">    # 消息需要使用exchange
</span></span><span class="line"><span class="cl">    producer.publish({&#39;hello&#39;: &#39;world&#39;},
</span></span><span class="line"><span class="cl">                     exchange=exchange,
</span></span><span class="line"><span class="cl">                     routing_key=&#39;kombu_demo&#39;,
</span></span><span class="line"><span class="cl">                     serializer=&#39;json&#39;, compression=&#39;zlib&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>生产者示例包括下面几步:</p>
<ul>
<li>创建名为kombu_demo的exchange</li>
<li>创建到broker的connection并使用其作为上下文</li>
<li>使用connection创建发送消息的producer</li>
<li>使用创建完成的producer发送普通的json消息到创建好的exchange，并且指明routing_key为kombu_demo。约定消息使用json序列化，zlib算法压缩。</li>
</ul>
<p>消费者的示例会略微复杂一点:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kombu-5.0.0/examples/complete_receive.py
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from pprint import pformat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">from kombu import Connection, Exchange, Queue, Consumer, eventloop
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">exchange = Exchange(&#39;kombu_demo&#39;, type=&#39;direct&#39;)
</span></span><span class="line"><span class="cl">queue = Queue(&#39;kombu_demo&#39;, exchange, routing_key=&#39;kombu_demo&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 格式化函数
</span></span><span class="line"><span class="cl">def pretty(obj):
</span></span><span class="line"><span class="cl">    return pformat(obj, indent=4)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#: This is the callback applied when a message is received.
</span></span><span class="line"><span class="cl">def handle_message(body, message):
</span></span><span class="line"><span class="cl">    print(f&#39;Received message: {body!r}&#39;)
</span></span><span class="line"><span class="cl">    print(&#39;  properties:\n{}&#39;.format(pretty(message.properties)))
</span></span><span class="line"><span class="cl">    print(&#39;  delivery_info:\n{}&#39;.format(pretty(message.delivery_info)))
</span></span><span class="line"><span class="cl">    message.ack()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">with Connection(&#39;amqp://guest:guest@localhost:5672//&#39;) as connection:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    with Consumer(connection, queue, callbacks=[handle_message]):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        for _ in eventloop(connection):
</span></span><span class="line"><span class="cl">            pass
</span></span></code></pre></td></tr></table>
</div>
</div><p>消费者示例主要包括下面几步:</p>
<ul>
<li>同样创建名为kombu_demo的exchange</li>
<li>创建名为kombu_demo的queue, 绑定到exchange，并且设置消费的routing_key</li>
<li>创建callback函数，接收body和message。body是纯粹的业务信息，message则包含一些投递信息，并且可以使用message直接执行ack回应给broker。</li>
<li>和生产者一样，创建到broker的connection并使用其作为上下文</li>
<li>使用connection创建消费者，消费者需要绑定到queue，并且设置callback函数</li>
<li>持续监听connection上的事件循环</li>
</ul>
<p>我们再回头看看下图，对比一下示例，加强理解：</p>
<p><img src="https://www.rabbitmq.com/img/tutorials/intro/hello-world-example-routing.png" alt="hello-world-example-routing"></p>
<p>示例中的生产者位于图的左半区，消费者位于图的右半区。中间部分的broker，在文章的第一篇里，我们使用redis服务作为broker。示例还有重要的一点就是，全程没有创建channel，都是自动创建的。一般情况下，我们有3个进程，Producer进程和Consumer进程通过Broker进程进行消息的处理，这是一个典型的分布式系统。</p>
<h2 id="producer--consumer-解析">Producer &amp;&amp; Consumer 解析</h2>
<h3 id="proudcer解析">Proudcer解析</h3>
<p>Proudcer的构造函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Producer:
</span></span><span class="line"><span class="cl">    def __init__(self, channel, exchange=None, routing_key=None,
</span></span><span class="line"><span class="cl">                 serializer=None, auto_declare=None, compression=None,
</span></span><span class="line"><span class="cl">                 on_return=None):
</span></span><span class="line"><span class="cl">        self._channel = channel
</span></span><span class="line"><span class="cl">        self.exchange = exchange
</span></span><span class="line"><span class="cl">        self.routing_key = routing_key or self.routing_key
</span></span><span class="line"><span class="cl">        self.serializer = serializer or self.serializer
</span></span><span class="line"><span class="cl">        self.compression = compression or self.compression
</span></span><span class="line"><span class="cl">        self.on_return = on_return or self.on_return
</span></span><span class="line"><span class="cl">        self._channel_promise = None
</span></span><span class="line"><span class="cl">        if self.exchange is None:
</span></span><span class="line"><span class="cl">            # 默认的exchange
</span></span><span class="line"><span class="cl">            self.exchange = Exchange(&#39;&#39;)
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if self._channel:
</span></span><span class="line"><span class="cl">            self.revive(self._channel)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def revive(self, channel):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;Revive the producer after connection loss.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        if is_connection(channel):
</span></span><span class="line"><span class="cl">            connection = channel
</span></span><span class="line"><span class="cl">            self.__connection__ = connection
</span></span><span class="line"><span class="cl">            channel = ChannelPromise(lambda: connection.default_channel)
</span></span><span class="line"><span class="cl">        if isinstance(channel, ChannelPromise):
</span></span><span class="line"><span class="cl">            self._channel = channel
</span></span><span class="line"><span class="cl">            self.exchange = self.exchange(channel)
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            # Channel already concrete
</span></span><span class="line"><span class="cl">            self._channel = channel
</span></span><span class="line"><span class="cl">            if self.on_return:
</span></span><span class="line"><span class="cl">                self._channel.events[&#39;basic_return&#39;].add(self.on_return)
</span></span><span class="line"><span class="cl">            self.exchange = self.exchange(channel)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Producer除了设置自身的属性外，还包括对channel的处理。前文介绍过connection也是channel的一种，这里要先处理好connection，然后再从connection获得默认的channel。同时对于已经成功的channel，则进行将producer绑定到channel。<code>self.exchange(channel)</code> 等同于 <code>self.exchange.__call__(channel)</code>。producer创建完成后，可以通过publish方法发送消息:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def publish(self, body, routing_key=None, delivery_mode=None,
</span></span><span class="line"><span class="cl">                mandatory=False, immediate=False, priority=0,
</span></span><span class="line"><span class="cl">                content_type=None, content_encoding=None, serializer=None,
</span></span><span class="line"><span class="cl">                headers=None, compression=None, exchange=None, retry=False,
</span></span><span class="line"><span class="cl">                retry_policy=None, declare=None, expiration=None, timeout=None,
</span></span><span class="line"><span class="cl">                **properties):
</span></span><span class="line"><span class="cl">    # 初始化routing-key, exchange
</span></span><span class="line"><span class="cl">    routing_key = self.routing_key if routing_key is None else routing_key
</span></span><span class="line"><span class="cl">    exchange_name, properties[&#39;delivery_mode&#39;] = self._delivery_details(
</span></span><span class="line"><span class="cl">            exchange or self.exchange, delivery_mode,
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">    # 准备body和body类型，编码
</span></span><span class="line"><span class="cl">    body, content_type, content_encoding = self._prepare(
</span></span><span class="line"><span class="cl">            body, serializer, content_type, content_encoding,
</span></span><span class="line"><span class="cl">            compression, headers)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    # 使用message封装body
</span></span><span class="line"><span class="cl">    message = self.channel.prepare_message(
</span></span><span class="line"><span class="cl">        body, priority, content_type,
</span></span><span class="line"><span class="cl">        content_encoding, headers, properties,
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    # 利用channel发送消息
</span></span><span class="line"><span class="cl">    return channel.basic_publish(
</span></span><span class="line"><span class="cl">        message,
</span></span><span class="line"><span class="cl">        exchange=exchange, routing_key=routing_key,
</span></span><span class="line"><span class="cl">        mandatory=mandatory, immediate=immediate,
</span></span><span class="line"><span class="cl">        timeout=timeout
</span></span><span class="line"><span class="cl">    )
</span></span></code></pre></td></tr></table>
</div>
</div><p>Producer是对channel的业务封装，创建时候有channel则使用channel，没有channel则使用connection的default_channel。Producer发送消息的过程，完成exchange和message包装后，使用channel进行发送。</p>
<h3 id="consumer解析">Consumer解析</h3>
<p>Consumer的构造函数和上下文：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Consumer:
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self, channel, queues=None, no_ack=None, auto_declare=None,
</span></span><span class="line"><span class="cl">                 callbacks=None, on_decode_error=None, on_message=None,
</span></span><span class="line"><span class="cl">                 accept=None, prefetch_count=None, tag_prefix=None):
</span></span><span class="line"><span class="cl">        self.channel = channel
</span></span><span class="line"><span class="cl">        # Queue的列表
</span></span><span class="line"><span class="cl">        self.queues = maybe_list(queues or [])
</span></span><span class="line"><span class="cl">        self.no_ack = self.no_ack if no_ack is None else no_ack
</span></span><span class="line"><span class="cl">        # 消息的回调函数
</span></span><span class="line"><span class="cl">        self.callbacks = (self.callbacks or [] if callbacks is None
</span></span><span class="line"><span class="cl">                          else callbacks)
</span></span><span class="line"><span class="cl">        # 自定义的消息处理方法
</span></span><span class="line"><span class="cl">        self.on_message = on_message
</span></span><span class="line"><span class="cl">        self.tag_prefix = tag_prefix
</span></span><span class="line"><span class="cl">        self._active_tags = {}
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if self.channel:
</span></span><span class="line"><span class="cl">            self.revive(self.channel)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def revive(self, channel):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;Revive consumer after connection loss.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        self._active_tags.clear()
</span></span><span class="line"><span class="cl">        channel = self.channel = maybe_channel(channel)
</span></span><span class="line"><span class="cl">        # modify dict size while iterating over it is not allowed
</span></span><span class="line"><span class="cl">        for qname, queue in list(self._queues.items()):
</span></span><span class="line"><span class="cl">            # name may have changed after declare
</span></span><span class="line"><span class="cl">            self._queues.pop(qname, None)
</span></span><span class="line"><span class="cl">            queue = self._queues[queue.name] = queue(self.channel)
</span></span><span class="line"><span class="cl">            # queue和channel绑定
</span></span><span class="line"><span class="cl">            queue.revive(channel)
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __enter__(self):
</span></span><span class="line"><span class="cl">        self.consume()
</span></span><span class="line"><span class="cl">        return self
</span></span></code></pre></td></tr></table>
</div>
</div><p>Consumer和Producer类似，设置完属性后也要处理好channel，不同的是其中的queue(在producer中是exchange)和channel绑定并提供一个上下文环境。在上下文环境中进行消息消费:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">no_ack</span><span class="o">=</span><span class="n">None</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nf">_add_tag</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span><span class="w"> </span><span class="n">consumer_tag</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1"># 每个queue消息消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">queue</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_queues</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">queue</span><span class="p">.</span><span class="nf">consume</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">_receive_callback</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                          </span><span class="n">no_ack</span><span class="o">=</span><span class="n">no_ack</span><span class="p">,</span><span class="w"> </span><span class="n">nowait</span><span class="o">=</span><span class="n">nowait</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">def</span><span class="w"> </span><span class="nf">_receive_callback</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">accept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">accept</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">on_m</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">decoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">on_message</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">None</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">try</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># 消息反序列化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="n">decoded</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">on_m</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">except</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">exc</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">on_decode_error</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">raise</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="nf">on_decode_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">exc</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">else</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nf">on_m</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">on_m</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;&#34;&#34;Method called when a message is received.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    This dispatches to the registered :attr:`callbacks`.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Arguments:
</span></span></span><span class="line"><span class="cl"><span class="s2">        body (Any): The decoded message body.
</span></span></span><span class="line"><span class="cl"><span class="s2">        message (~kombu.Message): The message instance.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Raises:
</span></span></span><span class="line"><span class="cl"><span class="s2">        NotImplementedError: If no consumer callbacks have been
</span></span></span><span class="line"><span class="cl"><span class="s2">            registered.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1"># 执行callback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">callbacks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">callbacks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1"># 默认就是body和message回传给业务函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="p">[</span><span class="nf">callback</span><span class="p">(</span><span class="n">body</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">callback</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">callbacks</span><span class="p">]</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>consumer可以使用多个queue，每个queue消费消息的时候可以使用覆盖处理函数或者使用系统的处理函数。一般情况下callback会获得到解码后的body和消息原文。如何持续的消费消息，在connection部分再介绍。</p>
<h2 id="exchange--queue-解析">Exchange &amp;&amp; Queue 解析</h2>
<p>producer需要使用exchange，consumer需要使用queue，消息是通过exchange和queue搭桥传递的。Exchange和Queue有共同的父类MaybeChannelBound:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">              +-------------------+
</span></span><span class="line"><span class="cl">              | MaybeChannelBound |
</span></span><span class="line"><span class="cl">              +-------^-----------+
</span></span><span class="line"><span class="cl">                      |
</span></span><span class="line"><span class="cl">     +----------------+----------------+
</span></span><span class="line"><span class="cl">     |                                 |
</span></span><span class="line"><span class="cl">+----+-----+                       +---+---+
</span></span><span class="line"><span class="cl">| Exchange |                       | Queue |
</span></span><span class="line"><span class="cl">+----------+                       +-------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>MaybeChannelBound约定了类对channel的绑定行为:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class MaybeChannelBound(Object):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    _channel = None
</span></span><span class="line"><span class="cl">    _is_bound = False
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __call__(self, channel):
</span></span><span class="line"><span class="cl">        &#34;&#34;&#34;`self(channel) -&gt; self.bind(channel)`.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">        return self.bind(channel)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>_channel 和 _is_bound 都是类属性，可以知道channel在类上重用</li>
<li>__call__魔法函数让类方法, 比如exchange(channel)和queue(channel)执行的时候会自动执行绑定到channel的动作。</li>
</ul>
<p>下面绑定channel的动作和是否绑定的判断也可以验证这一点。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def maybe_bind(self, channel):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Bind instance to channel if not already bound.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    if not self.is_bound and channel:
</span></span><span class="line"><span class="cl">        self._channel = maybe_channel(channel)
</span></span><span class="line"><span class="cl">        self.when_bound()
</span></span><span class="line"><span class="cl">        self._is_bound = True
</span></span><span class="line"><span class="cl">    return self
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@property
</span></span><span class="line"><span class="cl">def is_bound(self):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Flag set if the channel is bound.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    return self._is_bound and self._channel is not None
</span></span></code></pre></td></tr></table>
</div>
</div><p>exchange对象的创建和绑定到channel:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Exchange(MaybeChannelBound):
</span></span><span class="line"><span class="cl">    def __init__(self, name=&#39;&#39;, type=&#39;&#39;, channel=None, **kwargs):
</span></span><span class="line"><span class="cl">        super().__init__(**kwargs)
</span></span><span class="line"><span class="cl">        self.name = name or self.name
</span></span><span class="line"><span class="cl">        self.type = type or self.type
</span></span><span class="line"><span class="cl">        self.maybe_bind(channel)
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建完成的exchange对象需要进行申明，申明的过程就是让broker创建exchange的过程:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">def</span><span class="w"> </span><span class="k">declare</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">nowait</span><span class="o">=</span><span class="no">False</span><span class="p">,</span><span class="w"> </span><span class="n">passive</span><span class="o">=</span><span class="n">None</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="o">=</span><span class="n">None</span><span class="p">):</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s2">&#34;&#34;&#34;Declare the exchange.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Creates the exchange on the broker, unless passive is set
</span></span></span><span class="line"><span class="cl"><span class="s2">    in which case it will only assert that the exchange exists.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Argument:
</span></span></span><span class="line"><span class="cl"><span class="s2">        nowait (bool): If set the server will not respond, and a
</span></span></span><span class="line"><span class="cl"><span class="s2">            response will not be waited for. Default is :const:`False`.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="nf">_can_declare</span><span class="p">():</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">passive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">passive</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">passive</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">None</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">passive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1"># 依托于channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">channel</span><span class="p">).</span><span class="nf">exchange_declare</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">exchange</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">durable</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">durable</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">auto_delete</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">auto_delete</span><span class="p">,</span><span class="w"> </span><span class="n">arguments</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">nowait</span><span class="o">=</span><span class="n">nowait</span><span class="p">,</span><span class="w"> </span><span class="n">passive</span><span class="o">=</span><span class="n">passive</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>queue对象创建完成后也需要绑定到channel:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Queue(MaybeChannelBound):
</span></span><span class="line"><span class="cl">    def __init__(self, name=&#39;&#39;, exchange=None, routing_key=&#39;&#39;,
</span></span><span class="line"><span class="cl">                 channel=None, bindings=None, on_declared=None,
</span></span><span class="line"><span class="cl">                 **kwargs):
</span></span><span class="line"><span class="cl">        super().__init__(**kwargs)
</span></span><span class="line"><span class="cl">        self.name = name or self.name
</span></span><span class="line"><span class="cl">        self.maybe_bind(channel)
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后申明queue，这个过程包括下面3个步骤:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def declare(self, nowait=False, channel=None):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Declare queue and exchange then binds queue to exchange.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    if not self.no_declare:
</span></span><span class="line"><span class="cl">        # - declare main binding.
</span></span><span class="line"><span class="cl">        self._create_exchange(nowait=nowait, channel=channel)
</span></span><span class="line"><span class="cl">        self._create_queue(nowait=nowait, channel=channel)
</span></span><span class="line"><span class="cl">        self._create_bindings(nowait=nowait, channel=channel)
</span></span><span class="line"><span class="cl">    return self.name
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def _create_exchange(self, nowait=False, channel=None):
</span></span><span class="line"><span class="cl">    if self.exchange:
</span></span><span class="line"><span class="cl">        # 隐式申明exchange
</span></span><span class="line"><span class="cl">        self.exchange.declare(nowait=nowait, channel=channel)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def _create_queue(self, nowait=False, channel=None):
</span></span><span class="line"><span class="cl">    # 申明queue
</span></span><span class="line"><span class="cl">    self.queue_declare(nowait=nowait, passive=False, channel=channel)
</span></span><span class="line"><span class="cl">    if self.exchange and self.exchange.name:
</span></span><span class="line"><span class="cl">        # 绑定queue和exchange
</span></span><span class="line"><span class="cl">        self.queue_bind(nowait=nowait, channel=channel)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def _create_bindings(self, nowait=False, channel=None):
</span></span><span class="line"><span class="cl">    for B in self.bindings:
</span></span><span class="line"><span class="cl">        channel = channel or self.channel
</span></span><span class="line"><span class="cl">        B.declare(channel)
</span></span><span class="line"><span class="cl">        B.bind(self, nowait=nowait, channel=channel)
</span></span></code></pre></td></tr></table>
</div>
</div><p>queue的申明也是让broker创建queue:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def queue_declare(self, nowait=False, passive=False, channel=None):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    ret = channel.queue_declare(
</span></span><span class="line"><span class="cl">            queue=self.name,
</span></span><span class="line"><span class="cl">            passive=passive,
</span></span><span class="line"><span class="cl">            durable=self.durable,
</span></span><span class="line"><span class="cl">            exclusive=self.exclusive,
</span></span><span class="line"><span class="cl">            auto_delete=self.auto_delete,
</span></span><span class="line"><span class="cl">            arguments=queue_arguments,
</span></span><span class="line"><span class="cl">            nowait=nowait,
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>queue比exchange多一个步骤就是bind到exchange。queue_bind的工作是让broker创建queue和exchange的关联关系。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def queue_bind(self, nowait=False, channel=None):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Create the queue binding on the server.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    return (channel or self.channel).queue_bind(
</span></span><span class="line"><span class="cl">        queue=self.name,
</span></span><span class="line"><span class="cl">        exchange=exchange,
</span></span><span class="line"><span class="cl">        routing_key=routing_key,
</span></span><span class="line"><span class="cl">        arguments=arguments,
</span></span><span class="line"><span class="cl">        nowait=nowait,
</span></span><span class="line"><span class="cl">    )
</span></span></code></pre></td></tr></table>
</div>
</div><p>从Exchange和Queue的实现，我们可以知道生产者不用关心消费者的实现，只需要创建和申明exchange即可。消费者则是需要知道生产者，除了创建和申明queue后，还需要绑定queue和exchange的关系。又因为消费者和生产者在不同的进程，即使生成者创建了exchange，消费者也需要在本地隐式创建exchange对象。</p>
<h2 id="message-解析">Message 解析</h2>
<p>消息对象，除了纯粹的数据结构外，也包含channel的引用，毕竟消息可以直接执行ack动作:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Message:
</span></span><span class="line"><span class="cl">    def __init__(self, body=None, delivery_tag=None,
</span></span><span class="line"><span class="cl">                 content_type=None, content_encoding=None, delivery_info=None,
</span></span><span class="line"><span class="cl">                 properties=None, headers=None, postencode=None,
</span></span><span class="line"><span class="cl">                 accept=None, channel=None, **kwargs):
</span></span><span class="line"><span class="cl">        # 通道，主要的API来源
</span></span><span class="line"><span class="cl">        self.channel = channel
</span></span><span class="line"><span class="cl">        # 投递标签,可以用来响应
</span></span><span class="line"><span class="cl">        self.delivery_tag = delivery_tag
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self.headers = headers or {}
</span></span><span class="line"><span class="cl">        self.body = body
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self._state = &#39;RECEIVED&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>消息本身还带有四个状态:</p>
<ul>
<li><code>RECEIVED</code> 默认状态</li>
<li><code>ACK</code> 完成ack响应</li>
<li><code>REJECTED</code> 拒绝消息</li>
<li><code>REQUEUED</code> 重新投递消息</li>
</ul>
<p>其中 <code>{'ACK', 'REJECTED', 'REQUEUED'}</code> 三个状态的转换都需要使用channel进行操作broker，成功后再切换:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def ack(self, multiple=False):
</span></span><span class="line"><span class="cl">    # 回应ACK
</span></span><span class="line"><span class="cl">    self.channel.basic_ack(self.delivery_tag, multiple=multiple)
</span></span><span class="line"><span class="cl">    self._state = &#39;ACK&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def reject(self, requeue=False):
</span></span><span class="line"><span class="cl">    # 拒绝（抛弃消息）
</span></span><span class="line"><span class="cl">    self.channel.basic_reject(self.delivery_tag, requeue=requeue)
</span></span><span class="line"><span class="cl">    self._state = &#39;REJECTED&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def requeue(self):
</span></span><span class="line"><span class="cl">    # 拒绝（退回消息）（和reject区别在requeue=True）
</span></span><span class="line"><span class="cl">    self.channel.basic_reject(self.delivery_tag, requeue=True)
</span></span><span class="line"><span class="cl">    self._state = &#39;REQUEUED&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><p>消息上附带的信息，通过不同的load方法进行序列化:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from .serialization import loads
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@property
</span></span><span class="line"><span class="cl">def payload(self):
</span></span><span class="line"><span class="cl">    return loads(self.body, self.content_type,
</span></span><span class="line"><span class="cl">                     self.content_encoding, accept=self.accept)    
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="connection-解析">Connection 解析</h2>
<p>Connection负责管理producer/consumer到broker的网络连接:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Connection:
</span></span><span class="line"><span class="cl">    def __init__(self, hostname=&#39;localhost&#39;, userid=None,
</span></span><span class="line"><span class="cl">                 password=None, virtual_host=None, port=None, insist=False,
</span></span><span class="line"><span class="cl">                 ssl=False, transport=None, connect_timeout=5,
</span></span><span class="line"><span class="cl">                 transport_options=None, login_method=None, uri_prefix=None,
</span></span><span class="line"><span class="cl">                 heartbeat=0, failover_strategy=&#39;round-robin&#39;,
</span></span><span class="line"><span class="cl">                 alternates=None, **kwargs):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        params = self._initial_params = {
</span></span><span class="line"><span class="cl">            &#39;hostname&#39;: hostname, &#39;userid&#39;: userid,
</span></span><span class="line"><span class="cl">            &#39;password&#39;: password, &#39;virtual_host&#39;: virtual_host,
</span></span><span class="line"><span class="cl">            &#39;port&#39;: port, &#39;insist&#39;: insist, &#39;ssl&#39;: ssl,
</span></span><span class="line"><span class="cl">            &#39;transport&#39;: transport, &#39;connect_timeout&#39;: connect_timeout,
</span></span><span class="line"><span class="cl">            &#39;login_method&#39;: login_method, &#39;heartbeat&#39;: heartbeat
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        self._init_params(**params)
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>重点在_init_params中对各种支持AQMP协议的broker的管理, 比如redis，RobbitMQ:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def _init_params(self, hostname, userid, password, virtual_host, port,
</span></span><span class="line"><span class="cl">                 insist, ssl, transport, connect_timeout,
</span></span><span class="line"><span class="cl">                 login_method, heartbeat):
</span></span><span class="line"><span class="cl">    transport = transport or &#39;amqp&#39;
</span></span><span class="line"><span class="cl">    if transport == &#39;amqp&#39; and supports_librabbitmq():
</span></span><span class="line"><span class="cl">        transport = &#39;librabbitmq&#39;
</span></span><span class="line"><span class="cl">    if transport == &#39;rediss&#39; and ssl_available and not ssl:
</span></span><span class="line"><span class="cl">        logger.warning(
</span></span><span class="line"><span class="cl">            &#39;Secure redis scheme specified (rediss) with no ssl &#39;
</span></span><span class="line"><span class="cl">            &#39;options, defaulting to insecure SSL behaviour.&#39;
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        ssl = {&#39;ssl_cert_reqs&#39;: CERT_NONE}
</span></span><span class="line"><span class="cl">    self.hostname = hostname
</span></span><span class="line"><span class="cl">    self.userid = userid
</span></span><span class="line"><span class="cl">    self.password = password
</span></span><span class="line"><span class="cl">    self.login_method = login_method
</span></span><span class="line"><span class="cl">    # 虚拟主机隔离
</span></span><span class="line"><span class="cl">    self.virtual_host = virtual_host or self.virtual_host
</span></span><span class="line"><span class="cl">    self.port = port or self.port
</span></span><span class="line"><span class="cl">    self.insist = insist
</span></span><span class="line"><span class="cl">    self.connect_timeout = connect_timeout
</span></span><span class="line"><span class="cl">    self.ssl = ssl
</span></span><span class="line"><span class="cl">    # 传输类
</span></span><span class="line"><span class="cl">    self.transport_cls = transport
</span></span><span class="line"><span class="cl">    self.heartbeat = heartbeat and float(heartbeat)
</span></span></code></pre></td></tr></table>
</div>
</div><p>配置完connection信息后，就需要创建网络连接。这个过程通过调用connection属性或者default_channel属性时候自动创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">@property
</span></span><span class="line"><span class="cl">def connection(self):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;The underlying connection object.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Warning:
</span></span><span class="line"><span class="cl">        This instance is transport specific, so do not
</span></span><span class="line"><span class="cl">        depend on the interface of this object.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    if not self._closed:
</span></span><span class="line"><span class="cl">        if not self.connected:
</span></span><span class="line"><span class="cl">            # 创建连接
</span></span><span class="line"><span class="cl">            return self._ensure_connection(
</span></span><span class="line"><span class="cl">                max_retries=1, reraise_as_library_errors=False
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">        return self._connection
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">@property
</span></span><span class="line"><span class="cl">def default_channel(self):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Default channel.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Created upon access and closed when the connection is closed.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Note:
</span></span><span class="line"><span class="cl">        Can be used for automatic channel handling when you only need one
</span></span><span class="line"><span class="cl">        channel, and also it is the channel implicitly used if
</span></span><span class="line"><span class="cl">        a connection is passed instead of a channel, to functions that
</span></span><span class="line"><span class="cl">        require a channel.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    # make sure we&#39;re still connected, and if not refresh.
</span></span><span class="line"><span class="cl">    conn_opts = self._extract_failover_opts()
</span></span><span class="line"><span class="cl">    # 创建连接
</span></span><span class="line"><span class="cl">    self._ensure_connection(**conn_opts)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if self._default_channel is None:
</span></span><span class="line"><span class="cl">        self._default_channel = self.channel()
</span></span><span class="line"><span class="cl">    return self._default_channel
</span></span></code></pre></td></tr></table>
</div>
</div><p>连接创建完成后，继续创建channel:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def channel(self):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Create and return a new channel.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    self._debug(&#39;create channel&#39;)
</span></span><span class="line"><span class="cl">    chan = self.transport.create_channel(self.connection)
</span></span><span class="line"><span class="cl">    return chan
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def create_transport(self):
</span></span><span class="line"><span class="cl">    # 创建传输连接
</span></span><span class="line"><span class="cl">    return self.get_transport_cls()(client=self)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_transport_cls(self):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Get the currently used transport class.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    transport_cls = self.transport_cls
</span></span><span class="line"><span class="cl">    if not transport_cls or isinstance(transport_cls, str):
</span></span><span class="line"><span class="cl">        transport_cls = get_transport_cls(transport_cls)
</span></span><span class="line"><span class="cl">    return transport_cls
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建broker的连接过程，是通过transport的创建，其中细节涉及对不同类型的broker服务的适配，内容挺多，我们下一章再进行解析。</p>
<h2 id="matcher--serialization">Matcher &amp;&amp; serialization</h2>
<p>Matcher负责处理消息的匹配机制，serialization复杂消息的序列化。两者的实现方式类似，都使用注册中心模式+策略模式实现。</p>
<p>Matcher的注册中心:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class MatcherRegistry:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Pattern matching function registry.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;匹配器的注册中心&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    MatcherNotInstalled = MatcherNotInstalled
</span></span><span class="line"><span class="cl">    matcher_pattern_first = [&#34;pcre&#34;, ]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self):
</span></span><span class="line"><span class="cl">        self._matchers = {}
</span></span><span class="line"><span class="cl">        self._default_matcher = None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#: Global registry of matchers.
</span></span><span class="line"><span class="cl">registry = MatcherRegistry()
</span></span></code></pre></td></tr></table>
</div>
</div><p>注册glob(模糊)模式和pcre(正则)模式两种策略:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def register_glob():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register glob into default registry.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;使用glob(通配符)匹配&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    registry.register(&#39;glob&#39;, fnmatch)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def register_pcre():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register pcre into default registry.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;使用正则匹配&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    registry.register(&#39;pcre&#39;, rematch)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Register the base matching methods.
</span></span><span class="line"><span class="cl">register_glob()
</span></span><span class="line"><span class="cl">register_pcre()
</span></span></code></pre></td></tr></table>
</div>
</div><p>匹配消息的方法，就是使用模式进行识别:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def match(self, data, pattern, matcher=None, matcher_kwargs=None):
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Call the matcher.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    if matcher and not self._matchers.get(matcher):
</span></span><span class="line"><span class="cl">        raise self.MatcherNotInstalled(
</span></span><span class="line"><span class="cl">            f&#39;No matcher installed for {matcher}&#39;
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">    # 默认使用通配符匹配
</span></span><span class="line"><span class="cl">    match_func = self._matchers[matcher or &#39;glob&#39;]
</span></span><span class="line"><span class="cl">    # 通配符和正则匹配的传参先后顺序有差异
</span></span><span class="line"><span class="cl">    if matcher in self.matcher_pattern_first:
</span></span><span class="line"><span class="cl">        first_arg = bytes_to_str(pattern)
</span></span><span class="line"><span class="cl">        second_arg = bytes_to_str(data)
</span></span><span class="line"><span class="cl">    else:
</span></span><span class="line"><span class="cl">        first_arg = bytes_to_str(data)
</span></span><span class="line"><span class="cl">        second_arg = bytes_to_str(pattern)
</span></span><span class="line"><span class="cl">    return match_func(first_arg, second_arg, **matcher_kwargs or {})
</span></span></code></pre></td></tr></table>
</div>
</div><p>Serializer的注册中心:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SerializerRegistry:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;The registry keeps track of serialization methods.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;序列化方法的注册中心&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self):
</span></span><span class="line"><span class="cl">        self._encoders = {}
</span></span><span class="line"><span class="cl">        self._decoders = {}
</span></span><span class="line"><span class="cl">        self._default_encode = None
</span></span><span class="line"><span class="cl">        self._default_content_type = None
</span></span><span class="line"><span class="cl">        self._default_content_encoding = None
</span></span><span class="line"><span class="cl">        # 记录禁用的编解码类型
</span></span><span class="line"><span class="cl">        self._disabled_content_types = set()
</span></span><span class="line"><span class="cl">        # 双向字典，可以进行互查
</span></span><span class="line"><span class="cl">        self.type_to_name = {}
</span></span><span class="line"><span class="cl">        self.name_to_type = {}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># 全局单例，并且导出函数绑定，使用API更简介
</span></span><span class="line"><span class="cl">registry = SerializerRegistry()
</span></span><span class="line"><span class="cl">dumps = registry.dumps
</span></span><span class="line"><span class="cl">loads = registry.loads
</span></span><span class="line"><span class="cl">register = registry.register
</span></span><span class="line"><span class="cl">unregister = registry.unregister
</span></span></code></pre></td></tr></table>
</div>
</div><p>json, yaml, pickle和msgpack四种序列化策略的注册:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def register_json():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register a encoder/decoder for JSON serialization.&#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    from kombu.utils import json as _json
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    registry.register(&#39;json&#39;, _json.dumps, _json.loads,
</span></span><span class="line"><span class="cl">                      content_type=&#39;application/json&#39;,
</span></span><span class="line"><span class="cl">                      content_encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def register_yaml():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register a encoder/decoder for YAML serialization.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    It is slower than JSON, but allows for more data types
</span></span><span class="line"><span class="cl">    to be serialized. Useful if you need to send data such as dates
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    import yaml
</span></span><span class="line"><span class="cl">    registry.register(&#39;yaml&#39;, yaml.safe_dump, yaml.safe_load,
</span></span><span class="line"><span class="cl">                      content_type=&#39;application/x-yaml&#39;,
</span></span><span class="line"><span class="cl">                      content_encoding=&#39;utf-8&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def register_pickle():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register pickle serializer.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    The fastest serialization method, but restricts
</span></span><span class="line"><span class="cl">    you to python clients.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    def pickle_dumps(obj, dumper=pickle.dumps):
</span></span><span class="line"><span class="cl">        return dumper(obj, protocol=pickle_protocol)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    registry.register(&#39;pickle&#39;, pickle_dumps, unpickle,
</span></span><span class="line"><span class="cl">                      content_type=&#39;application/x-python-serialize&#39;,
</span></span><span class="line"><span class="cl">                      content_encoding=&#39;binary&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def register_msgpack():
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Register msgpack serializer.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    See Also:
</span></span><span class="line"><span class="cl">        https://msgpack.org/.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">    pack = unpack = None
</span></span><span class="line"><span class="cl">    import msgpack
</span></span><span class="line"><span class="cl">    from msgpack import packb, unpackb
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def pack(s):
</span></span><span class="line"><span class="cl">        return packb(s, use_bin_type=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def unpack(s):
</span></span><span class="line"><span class="cl">        return unpackb(s, raw=False)
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    registry.register(
</span></span><span class="line"><span class="cl">        &#39;msgpack&#39;, pack, unpack,
</span></span><span class="line"><span class="cl">        content_type=&#39;application/x-msgpack&#39;,
</span></span><span class="line"><span class="cl">        content_encoding=&#39;binary&#39;,
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">register_json()
</span></span><span class="line"><span class="cl">register_pickle()
</span></span><span class="line"><span class="cl">register_yaml()
</span></span><span class="line"><span class="cl">register_msgpack()
</span></span></code></pre></td></tr></table>
</div>
</div><p>反序列化的使用:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># kombu-5.0.0/kombu/serialization.py:285
</span></span><span class="line"><span class="cl"># 导出策略
</span></span><span class="line"><span class="cl">loads = registry.loads
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># kombu-5.0.0/kombu/message.py:10
</span></span><span class="line"><span class="cl">from .serialization import loads
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Message:
</span></span><span class="line"><span class="cl">    def _decode(self):
</span></span><span class="line"><span class="cl">        # 使用策略反序列化message-body
</span></span><span class="line"><span class="cl">        return loads(self.body, self.content_type,
</span></span><span class="line"><span class="cl">                     self.content_encoding, accept=self.accept)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="小结">小结</h2>
<p>通过kombu的Producer可以发送消息到broker，使用Comsumer则可以消费消息。发送消息的时候需要使用Exchange，用来将消费分发到不同的目标Queue；消费消息的时候，需要使用Queue，Queue还需要通过绑定的方式和Exchange关联起来。Exchange和Queue都是使用底层的channel进行数据传输，所以需要进绑定(binding)；还需要在远程的broker中创建，所以创建后的的Exchange和Queue需要进行申明(declare)。消息会附带上投递信息，进行序列化后从生产者到broker转发给消费者，消费者再使用投递信息上的序列化约定，将消息反序列成业务信息。</p>
<h2 id="小技巧">小技巧</h2>
<h3 id="pickle打包函数">pickle打包函数</h3>
<p>pickle不仅支持数据接口的序列化，还支持函数的序列化:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">python3
</span></span><span class="line"><span class="cl">Python 3.8.5 (v3.8.5:580fbb018f, Jul 20 2020, 12:11:27)
</span></span><span class="line"><span class="cl">[Clang 6.0 (clang-600.0.57)] on darwin
</span></span><span class="line"><span class="cl">Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; import pickle
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; def hello(msg):
</span></span><span class="line"><span class="cl">...     print(&#34;hello&#34;, msg)
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; p = pickle.dumps(hello)
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; p
</span></span><span class="line"><span class="cl">b&#39;\x80\x04\x95\x16\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x05hello\x94\x93\x94.&#39;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; q = pickle.loads(p)
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; q(&#34;python&#34;)
</span></span><span class="line"><span class="cl">hello python
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>上面的hello函数可以通过pickle打包，再重新解包执行。利用这个机制使用kombu，可以将producer进程的函数发送到consumer进程远程执行。pickle支持的数据类型还挺丰富，官方文档中介绍包括下面多种类型:</p>
<blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-v" data-lang="v"><span class="line"><span class="cl"><span class="nc">The</span> <span class="nv">following</span> <span class="nv">types</span> <span class="nv">can</span> <span class="nv">be</span> <span class="nl">pickled</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nc">None</span><span class="p">,</span> <span class="nc">True</span><span class="p">,</span> <span class="nv">and</span> <span class="nc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">integers</span><span class="p">,</span> <span class="nv">floating</span> <span class="nv">point</span> <span class="nv">numbers</span><span class="p">,</span> <span class="nv">complex</span> <span class="nv">numbers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">strings</span><span class="p">,</span> <span class="nv">bytes</span><span class="p">,</span> <span class="nv">bytearrays</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">tuples</span><span class="p">,</span> <span class="nv">lists</span><span class="p">,</span> <span class="nv">sets</span><span class="p">,</span> <span class="nv">and</span> <span class="nv">dictionaries</span> <span class="nv">containing</span> <span class="nv">only</span> <span class="nv">picklable</span> <span class="nv">objects</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">functions</span> <span class="nv">defined</span> <span class="nv">at</span> <span class="nv">the</span> <span class="nv">top</span> <span class="nv">level</span> <span class="nv">of</span> <span class="nv">a</span> <span class="kn">module</span> <span class="p">(</span><span class="nv">using</span> <span class="nv">def</span><span class="p">,</span> <span class="nv">not</span> <span class="nv">lambda</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">built</span><span class="o">-</span><span class="k">in</span> <span class="nv">functions</span> <span class="nv">defined</span> <span class="nv">at</span> <span class="nv">the</span> <span class="nv">top</span> <span class="nv">level</span> <span class="nv">of</span> <span class="nv">a</span> <span class="kn">module</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">classes</span> <span class="nv">that</span> <span class="nv">are</span> <span class="nv">defined</span> <span class="nv">at</span> <span class="nv">the</span> <span class="nv">top</span> <span class="nv">level</span> <span class="nv">of</span> <span class="nv">a</span> <span class="kn">module</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">*</span> <span class="nv">instances</span> <span class="nv">of</span> <span class="nv">such</span> <span class="nv">classes</span> <span class="nv">whose</span> <span class="nv">__dict__</span> <span class="k">or</span> <span class="nv">the</span> <span class="nv">result</span> <span class="nv">of</span> <span class="nv">calling</span> <span class="nf">__getstate__</span><span class="p">()</span> <span class="k">is</span> <span class="nv">picklable</span> <span class="p">(</span><span class="nv">see</span> <span class="nv">section</span> <span class="nc">Pickling</span> <span class="nc">Class</span> <span class="nc">Instances</span> <span class="k">for</span> <span class="nv">details</span><span class="p">).</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<h3 id="配置类的简化">配置类的简化</h3>
<p><code>Object</code>提供了一种快速构建对象的方法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Object:
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;Common base class.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    Supports automatic kwargs-&gt;attributes handling, and cloning.
</span></span><span class="line"><span class="cl">    &#34;&#34;&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    attrs = ()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self, *args, **kwargs):
</span></span><span class="line"><span class="cl">        # attrs 在子类中定义
</span></span><span class="line"><span class="cl">        for name, type_ in self.attrs:
</span></span><span class="line"><span class="cl">            value = kwargs.get(name)
</span></span><span class="line"><span class="cl">            # 从字典参数给属性动态赋值
</span></span><span class="line"><span class="cl">            if value is not None:
</span></span><span class="line"><span class="cl">                setattr(self, name, (type_ or _any)(value))
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                try:
</span></span><span class="line"><span class="cl">                    getattr(self, name)
</span></span><span class="line"><span class="cl">                except AttributeError:
</span></span><span class="line"><span class="cl">                    setattr(self, name, None)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Queue展示了这种方式的示例，比如max_length属性:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Queue(MaybeChannelBound):
</span></span><span class="line"><span class="cl">    attrs = (
</span></span><span class="line"><span class="cl">        ..
</span></span><span class="line"><span class="cl">        (&#39;max_length&#39;, int),
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    def __init__(self, name=&#39;&#39;, exchange=None, routing_key=&#39;&#39;,
</span></span><span class="line"><span class="cl">                 channel=None, bindings=None, on_declared=None,
</span></span><span class="line"><span class="cl">                 **kwargs):
</span></span><span class="line"><span class="cl">        self.name = name or self.name
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def queue_declare(self, nowait=False, passive=False, channel=None):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        queue_arguments = channel.prepare_queue_arguments(
</span></span><span class="line"><span class="cl">            self.queue_arguments or {},
</span></span><span class="line"><span class="cl">            expires=self.expires,
</span></span><span class="line"><span class="cl">            message_ttl=self.message_ttl,
</span></span><span class="line"><span class="cl">            max_length=self.max_length,
</span></span><span class="line"><span class="cl">            max_length_bytes=self.max_length_bytes,
</span></span><span class="line"><span class="cl">            max_priority=self.max_priority,
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>在Queue的构造函数中并没有定义max_length属性，但是queue_declare中却可以直接使用这个属性，可以对比name属性感受一下差异。这对我们简化定义属性很多的对象有帮助，比如一些配置类。</p>
<h3 id="使用count提供自增id">使用count提供自增ID</h3>
<p><code>itertools.count</code>提供了一种通过迭代器生成递增ID的方法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">&gt;&gt;&gt; from itertools import count
</span></span><span class="line"><span class="cl">&gt;&gt;&gt;
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; for i in count():
</span></span><span class="line"><span class="cl">...     if i % 10 == 0:
</span></span><span class="line"><span class="cl">...             print(i)
</span></span><span class="line"><span class="cl">...     if i&gt;50:
</span></span><span class="line"><span class="cl">...             break
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">0
</span></span><span class="line"><span class="cl">10
</span></span><span class="line"><span class="cl">20
</span></span><span class="line"><span class="cl">30
</span></span><span class="line"><span class="cl">40
</span></span><span class="line"><span class="cl">50
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考连接">参考连接</h2>
<ul>
<li><a href="https://github.com/celery/kombu">https://github.com/celery/kombu</a></li>
<li>Talking to RabbitMQ with Python and Kombu <a href="https://medium.com/python-pandemonium/talking-to-rabbitmq-with-python-and-kombu-6cbee93b1298">https://medium.com/python-pandemonium/talking-to-rabbitmq-with-python-and-kombu-6cbee93b1298</a></li>
<li>一篇文章讲透彻了AMQP协议 <a href="https://jishuin.proginn.com/p/763bfbd2a068">https://jishuin.proginn.com/p/763bfbd2a068</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">shawn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-10-25
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/celery/">celery</a>
          <a href="/tags/%E6%BA%90%E7%A0%81/">源码</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/service-lang/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">谁是虽好的语言 ？- 语言选型闲聊（上）</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/python/celery-2/">
            <span class="next-text nav-default">神器 celery 源码解析 - 2 </span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '2021-10-25 21:19:23 \u002b0800 CST',
        title: '神器 celery 源码解析 - 3',
        link: decodeURI(location.href),
        desc: 'kombu，一个python实现的消息库，是celery的基础库，在celery中承担核心的消息处理流程。 Celery是一款非常简单、灵活、',
        owner: 'game404',
        repo: 'game404.github.io',
        oauth: {
          client_id: '28a86ccaa3184b49dfc4',
          client_secret: '15ab0f7c1445c0afb5e3d7a8995c89f2fd081eb7'
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:studyoo@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/game404" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/593f44b8da2f60006736604e" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://game404.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>game404</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137813525-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
