<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>SQLAlchemy源码阅读-下篇 - 游戏不存在</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="shawn" /><meta name="description" content="SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案" /><meta name="keywords" content="game, docker, kubernetes, python, go,  microservice" />






<meta name="generator" content="Hugo 0.101.0 with theme even" />


<link rel="canonical" href="https://game404.github.io/post/python/sqlalchemy-part-2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="SQLAlchemy源码阅读-下篇" />
<meta property="og:description" content="SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://game404.github.io/post/python/sqlalchemy-part-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-29T22:38:13+08:00" />
<meta property="article:modified_time" content="2021-04-29T22:38:13+08:00" />

<meta itemprop="name" content="SQLAlchemy源码阅读-下篇">
<meta itemprop="description" content="SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案"><meta itemprop="datePublished" content="2021-04-29T22:38:13+08:00" />
<meta itemprop="dateModified" content="2021-04-29T22:38:13+08:00" />
<meta itemprop="wordCount" content="5853">
<meta itemprop="keywords" content="database,源码," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SQLAlchemy源码阅读-下篇"/>
<meta name="twitter:description" content="SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">游戏不存在</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">游戏不存在</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">SQLAlchemy源码阅读-下篇</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-04-29 </span>
        <div class="post-category">
            <a href="/categories/python/"> python </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#sql-schema使用示例">SQL-schema使用示例</a></li>
    <li><a href="#ddldata-definition-language创建table">DDL(Data Definition Language)创建table</a></li>
    <li><a href="#dmldata-manipulation-language使用insert插入数据">DML(Data Manipulation Language)使用insert插入数据</a></li>
    <li><a href="#dqldata-query-language使用select查询数据">DQL(Data Query Language)使用select查询数据</a></li>
    <li><a href="#orm-示例">ORM 示例</a></li>
    <li><a href="#model核心功能">model核心功能</a></li>
    <li><a href="#小结">小结</a></li>
    <li><a href="#小技巧">小技巧</a></li>
    <li><a href="#一点感悟">一点感悟</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案，旨在高效，高性能地访问数据库，并符合Pythonic之禅。项目代码量比较大，接近200个文件，7万行代码， 我们一起来挑战一下。由于篇幅原因，分成上下两篇，上篇我们学习了core部分的engine，dialect，connection和pool等部分，下篇主要学习core部分剩余的sql表达式和orm部分，包括如下内容:</p>
<ul>
<li>SQL-schema使用示例</li>
<li>DDL(Data Definition Language)创建table</li>
<li>DML(Data Manipulation Language)使用insert插入数据</li>
<li>DQL(Data Query Language)使用select查询数据</li>
<li>ORM示例</li>
<li>model核心功能</li>
<li>小结</li>
<li>小技巧</li>
<li>一点感悟</li>
</ul>
<h2 id="sql-schema使用示例">SQL-schema使用示例</h2>
<p>上篇中，我们使用的sql都是手工编写的语句，下面这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create table x (a integer, b integer)
</span></span><span class="line"><span class="cl">insert into x (a, b) values (1, 1)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在sqlalchemy中可以通过定义schema的方式进行数据操作，完整的示例如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from sqlalchemy import create_engine
</span></span><span class="line"><span class="cl">from sqlalchemy import MetaData
</span></span><span class="line"><span class="cl">from sqlalchemy import Table
</span></span><span class="line"><span class="cl">from sqlalchemy import Column
</span></span><span class="line"><span class="cl">from sqlalchemy import Integer
</span></span><span class="line"><span class="cl">from sqlalchemy import String
</span></span><span class="line"><span class="cl">from sqlalchemy.sql import select
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">engine = create_engine(&#39;sqlite:///:memory:&#39;, echo=True)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">metadata = MetaData()
</span></span><span class="line"><span class="cl">users = Table(&#39;users&#39;, metadata,
</span></span><span class="line"><span class="cl">              Column(&#39;id&#39;, Integer, primary_key=True),
</span></span><span class="line"><span class="cl">              Column(&#39;name&#39;, String),
</span></span><span class="line"><span class="cl">              Column(&#39;fullname&#39;, String),
</span></span><span class="line"><span class="cl">              )
</span></span><span class="line"><span class="cl">metadata.create_all(engine)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ins = users.insert().values(name=&#39;jack&#39;, fullname=&#39;Jack Jones&#39;)
</span></span><span class="line"><span class="cl">print(ins)
</span></span><span class="line"><span class="cl">result = engine.execute(ins)
</span></span><span class="line"><span class="cl">print(result, result.inserted_primary_key)
</span></span><span class="line"><span class="cl">s = select([users])
</span></span><span class="line"><span class="cl">result = conn.execute(s)
</span></span><span class="line"><span class="cl">for row in result:
</span></span><span class="line"><span class="cl">    print(row)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">result = engine.execute(&#34;select * from users&#34;)
</span></span><span class="line"><span class="cl">for row in result:
</span></span><span class="line"><span class="cl">    print(row)
</span></span></code></pre></td></tr></table>
</div>
</div><p>示例程序的执行过程:</p>
<ul>
<li>创建engine，用于数据库连接</li>
<li>创建metadata，用于管理schema</li>
<li>创建users表的Table，绑定到metadata；同时包括id，name和fullname三个column</li>
<li>将metadata提交到engine(创建表)</li>
<li>使用users插入数据</li>
<li>查询users的数据</li>
<li>使用普通sql的方式验证数据</li>
</ul>
<p>下面是示例的执行日志,清晰展示了上面过程:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,166 INFO sqlalchemy.engine.base.Engine 
</span></span><span class="line"><span class="cl">CREATE TABLE users (
</span></span><span class="line"><span class="cl">	id INTEGER NOT NULL, 
</span></span><span class="line"><span class="cl">	name VARCHAR, 
</span></span><span class="line"><span class="cl">	fullname VARCHAR, 
</span></span><span class="line"><span class="cl">	PRIMARY KEY (id)
</span></span><span class="line"><span class="cl">)
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,166 INFO sqlalchemy.engine.base.Engine ()
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,167 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span class="line"><span class="cl">INSERT INTO users (name, fullname) VALUES (:name, :fullname)
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,167 INFO sqlalchemy.engine.base.Engine INSERT INTO users (name, fullname) VALUES (?, ?)
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,168 INFO sqlalchemy.engine.base.Engine (&#39;jack&#39;, &#39;Jack Jones&#39;)
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,168 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span class="line"><span class="cl">&lt;sqlalchemy.engine.result.ResultProxy object at 0x7ffca0607070&gt; [1]
</span></span><span class="line"><span class="cl">2021-04-27 11:38:19,134 INFO sqlalchemy.engine.base.Engine SELECT users.id, users.name, users.fullname 
</span></span><span class="line"><span class="cl">FROM users
</span></span><span class="line"><span class="cl">2021-04-27 11:38:19,134 INFO sqlalchemy.engine.base.Engine ()
</span></span><span class="line"><span class="cl">(1, &#39;jack&#39;, &#39;Jack Jones&#39;)
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,168 INFO sqlalchemy.engine.base.Engine select * from users
</span></span><span class="line"><span class="cl">2021-04-19 10:02:09,168 INFO sqlalchemy.engine.base.Engine ()
</span></span><span class="line"><span class="cl">(1, &#39;jack&#39;, &#39;Jack Jones&#39;)
</span></span></code></pre></td></tr></table>
</div>
</div><p>在开始之前，我们需要简单了解一下SQL语句的分类:
<img src="https://media.geeksforgeeks.org/wp-content/cdn-uploads/20190826175059/Types-of-SQL-Commands.jpg" alt="SQL"></p>
<p>在我们的schema使用示例中，就包括了DDL，DML和DQL三种类型的语句，下面我们按照这3种类型，详细了解一下sqlalchemy的sql表达式部分。sql表达式主要在sql包中，部分文件的功能如下:</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>base.py</td>
<td>基础类</td>
</tr>
<tr>
<td>compiler.py</td>
<td>sql编译</td>
</tr>
<tr>
<td>crud.py</td>
<td>crud的参数处理</td>
</tr>
<tr>
<td>ddl.py</td>
<td>DDL语句</td>
</tr>
<tr>
<td>default_comparator.py</td>
<td>比较</td>
</tr>
<tr>
<td>dml.py</td>
<td>DML语句</td>
</tr>
<tr>
<td>elements.py</td>
<td>基本类型</td>
</tr>
<tr>
<td>operators.py</td>
<td>sql操作符</td>
</tr>
<tr>
<td>schema.py</td>
<td>schema定义</td>
</tr>
<tr>
<td>selectable.py</td>
<td>DQL</td>
</tr>
<tr>
<td>sqltypes.py&amp;&amp;type_api.py</td>
<td>sql数据类型</td>
</tr>
<tr>
<td>vistitors.py</td>
<td>递归算法</td>
</tr>
</tbody>
</table>
<h2 id="ddldata-definition-language创建table">DDL(Data Definition Language)创建table</h2>
<p>首先了解一下schema的基础实现visitable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class VisitableType(type):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(cls, clsname, bases, clsdict):
</span></span><span class="line"><span class="cl">        if clsname != &#34;Visitable&#34; and hasattr(cls, &#34;__visit_name__&#34;):
</span></span><span class="line"><span class="cl">            _generate_dispatch(cls)
</span></span><span class="line"><span class="cl">        super(VisitableType, cls).__init__(clsname, bases, clsdict)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def _generate_dispatch(cls):
</span></span><span class="line"><span class="cl">    if &#34;__visit_name__&#34; in cls.__dict__:
</span></span><span class="line"><span class="cl">        visit_name = cls.__visit_name__
</span></span><span class="line"><span class="cl">        if isinstance(visit_name, str):
</span></span><span class="line"><span class="cl">            getter = operator.attrgetter(&#34;visit_%s&#34; % visit_name)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            def _compiler_dispatch(self, visitor, **kw):
</span></span><span class="line"><span class="cl">                try:
</span></span><span class="line"><span class="cl">                    meth = getter(visitor)
</span></span><span class="line"><span class="cl">                except AttributeError:
</span></span><span class="line"><span class="cl">                    raise exc.UnsupportedCompilationError(visitor, cls)
</span></span><span class="line"><span class="cl">                else:
</span></span><span class="line"><span class="cl">                    return meth(self, **kw)
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        cls._compiler_dispatch = _compiler_dispatch
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Visitable(util.with_metaclass(VisitableType, object)):
</span></span><span class="line"><span class="cl">    pass
</span></span></code></pre></td></tr></table>
</div>
</div><p>Visitable约定子类必须提供 <strong>visit_name</strong> 的类属性，用来绑定编译方法。参与sql的类都继承自Visitable:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SchemaItem(SchemaEventTarget, visitors.Visitable):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;schema_item&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class MetaData(SchemaItem):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;metadata&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class Table(DialectKWArgs, SchemaItem, TableClause):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;table&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Column(DialectKWArgs, SchemaItem, ColumnClause):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;column&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class TypeEngine(Visitable):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Integer(_LookupExpressionAdapter, TypeEngine):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;integer&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>MetaData是schema的集合，记录了所有的Table定义, 通过 <code>_add_table</code> 函数用来添加表:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class MetaData(SchemaItem):
</span></span><span class="line"><span class="cl">    def __init__(
</span></span><span class="line"><span class="cl">        self,
</span></span><span class="line"><span class="cl">        bind=None,
</span></span><span class="line"><span class="cl">        reflect=False,
</span></span><span class="line"><span class="cl">        schema=None,
</span></span><span class="line"><span class="cl">        quote_schema=None,
</span></span><span class="line"><span class="cl">        naming_convention=None,
</span></span><span class="line"><span class="cl">        info=None,
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        # table集合
</span></span><span class="line"><span class="cl">        self.tables = util.immutabledict()
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        self.schema = quoted_name(schema, quote_schema)
</span></span><span class="line"><span class="cl">        self._schemas = set()
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def _add_table(self, name, schema, table):
</span></span><span class="line"><span class="cl">        key = _get_table_key(name, schema)
</span></span><span class="line"><span class="cl">        dict.__setitem__(self.tables, key, table)
</span></span><span class="line"><span class="cl">        if schema:
</span></span><span class="line"><span class="cl">            self._schemas.add(schema)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Table是column的集合，在创建table对象的时候，把自己添加到metadata中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Table(DialectKWArgs, SchemaItem, TableClause):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __new__(cls, *args, **kw):
</span></span><span class="line"><span class="cl">        name, metadata, args = args[0], args[1], args[2:]
</span></span><span class="line"><span class="cl">        schema = metadata.schema
</span></span><span class="line"><span class="cl">        table = object.__new__(cls)
</span></span><span class="line"><span class="cl">        # 添加到metadata
</span></span><span class="line"><span class="cl">        metadata._add_table(name, schema, table)
</span></span><span class="line"><span class="cl">        table._init(name, metadata, *args, **kw)
</span></span><span class="line"><span class="cl">        return table
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def _init(self, name, metadata, *args, **kwargs):
</span></span><span class="line"><span class="cl">        super(Table, self).__init__(
</span></span><span class="line"><span class="cl">            quoted_name(name, kwargs.pop(&#34;quote&#34;, None))
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        self.metadata = metadata
</span></span><span class="line"><span class="cl">        self.schema = metadata.schema
</span></span><span class="line"><span class="cl">        # column集合
</span></span><span class="line"><span class="cl">        self._columns = ColumnCollection()
</span></span><span class="line"><span class="cl">        self._init_items(*args)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def _init_items(self, *args):
</span></span><span class="line"><span class="cl">        # column 
</span></span><span class="line"><span class="cl">        for item in args:
</span></span><span class="line"><span class="cl">            if item is not None:
</span></span><span class="line"><span class="cl">                item._set_parent_with_dispatch(self)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Column是通过下面的方法将column添加到table的colummns中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class Column(DialectKWArgs, SchemaItem, ColumnClause):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self, *args, **kwargs):
</span></span><span class="line"><span class="cl">        pass
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    def _set_parent(self, table):
</span></span><span class="line"><span class="cl">        table._columns.replace(self)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class ColumnCollection(util.OrderedProperties):
</span></span><span class="line"><span class="cl">    def replace(self, column):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self._data[column.key] = column
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>现阶段，我们大概厘清了metadata，table和column的数据结构：metadata持有table集合，table持有column集合。接下来我们看看这个数据结构如何转换成sql语句，API是通过 <code>MetaData.create_all</code> 函数实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class MetaData(SchemaItem):
</span></span><span class="line"><span class="cl">    def create_all(self, bind=None, tables=None, checkfirst=True):
</span></span><span class="line"><span class="cl">        bind._run_visitor(
</span></span><span class="line"><span class="cl">            ddl.SchemaGenerator, self, checkfirst=checkfirst, tables=tables
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Engine(Connectable, log.Identified):
</span></span><span class="line"><span class="cl">    def _run_visitor(
</span></span><span class="line"><span class="cl">        self, visitorcallable, element, connection=None, **kwargs
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        with self._optional_conn_ctx_manager(connection) as conn:
</span></span><span class="line"><span class="cl">            conn._run_visitor(visitorcallable, element, **kwargs)
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">class Connection(Connectable):
</span></span><span class="line"><span class="cl">    def _run_visitor(self, visitorcallable, element, **kwargs):
</span></span><span class="line"><span class="cl">        visitorcallable(self.dialect, self, **kwargs).traverse_single(element)
</span></span></code></pre></td></tr></table>
</div>
</div><p>create-table的sql编译主要由ddl中的SchemaGenerator实现, 下面是SchemaGenerator的继承关系和核心的traverse_single函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class ClauseVisitor(object):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def traverse_single(self, obj, **kw):
</span></span><span class="line"><span class="cl">        # 遍历所有的visit实现 
</span></span><span class="line"><span class="cl">        for v in self.visitor_iterator:
</span></span><span class="line"><span class="cl">            meth = getattr(v, &#34;visit_%s&#34; % obj.__visit_name__, None)
</span></span><span class="line"><span class="cl">            if meth:
</span></span><span class="line"><span class="cl">                return meth(obj, **kw)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    @property
</span></span><span class="line"><span class="cl">    def visitor_iterator(self):
</span></span><span class="line"><span class="cl">        v = self
</span></span><span class="line"><span class="cl">        while v:
</span></span><span class="line"><span class="cl">            yield v
</span></span><span class="line"><span class="cl">            v = getattr(v, &#34;_next&#34;, None)
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">class SchemaVisitor(ClauseVisitor):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class DDLBase(SchemaVisitor):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class SchemaGenerator(DDLBase):
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建meta，table和columun的过程:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SchemaGenerator(DDLBase):
</span></span><span class="line"><span class="cl">    def visit_metadata(self, metadata):
</span></span><span class="line"><span class="cl">        tables = list(metadata.tables.values())
</span></span><span class="line"><span class="cl">        collection = sort_tables_and_constraints(
</span></span><span class="line"><span class="cl">            [t for t in tables if self._can_create_table(t)]
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        for table, fkcs in collection:
</span></span><span class="line"><span class="cl">            if table is not None:
</span></span><span class="line"><span class="cl">                # 创建表 
</span></span><span class="line"><span class="cl">                self.traverse_single(
</span></span><span class="line"><span class="cl">                    table,
</span></span><span class="line"><span class="cl">                    create_ok=True,
</span></span><span class="line"><span class="cl">                    include_foreign_key_constraints=fkcs,
</span></span><span class="line"><span class="cl">                    _is_metadata_operation=True,
</span></span><span class="line"><span class="cl">                )
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    def visit_table(
</span></span><span class="line"><span class="cl">        self,
</span></span><span class="line"><span class="cl">        table,
</span></span><span class="line"><span class="cl">        create_ok=False,
</span></span><span class="line"><span class="cl">        include_foreign_key_constraints=None,
</span></span><span class="line"><span class="cl">        _is_metadata_operation=False,
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        for column in table.columns:
</span></span><span class="line"><span class="cl">            if column.default is not None:
</span></span><span class="line"><span class="cl">                # 创建column-DDLElement
</span></span><span class="line"><span class="cl">                self.traverse_single(column.default)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        self.connection.execute(
</span></span><span class="line"><span class="cl">            # fmt: off
</span></span><span class="line"><span class="cl">            # 创建create-table-DDLElement
</span></span><span class="line"><span class="cl">            CreateTable(
</span></span><span class="line"><span class="cl">                table,
</span></span><span class="line"><span class="cl">                include_foreign_key_constraints=  # noqa
</span></span><span class="line"><span class="cl">                    include_foreign_key_constraints,
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">            # fmt: on
</span></span><span class="line"><span class="cl">        )
</span></span></code></pre></td></tr></table>
</div>
</div><p>CreateTableDDLElement和CreateColumnDDLElement的继承关系:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class _DDLCompiles(ClauseElement):
</span></span><span class="line"><span class="cl">    def _compiler(self, dialect, **kw):
</span></span><span class="line"><span class="cl">        return dialect.ddl_compiler(dialect, self, **kw)
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">class DDLElement(Executable, _DDLCompiles):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class _CreateDropBase(DDLElement):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class CreateTable(_CreateDropBase):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;create_table&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(
</span></span><span class="line"><span class="cl">        self, element, on=None, bind=None, include_foreign_key_constraints=None
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        super(CreateTable, self).__init__(element, on=on, bind=bind)
</span></span><span class="line"><span class="cl">        self.columns = [CreateColumn(column) for column in element.columns]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class CreateColumn(_DDLCompiles):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;create_column&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __init__(self, element):
</span></span><span class="line"><span class="cl">        self.element = element
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终这些DDLElement在compiler中被DDLCompiler编译成sql语句, <code>CREATE TABLE</code>是这样被编译的:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def visit_create_table(self, create):
</span></span><span class="line"><span class="cl">    table = create.element
</span></span><span class="line"><span class="cl">    preparer = self.preparer
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    text = &#34;\nCREATE &#34;
</span></span><span class="line"><span class="cl">    if table._prefixes:
</span></span><span class="line"><span class="cl">        text += &#34; &#34;.join(table._prefixes) + &#34; &#34;
</span></span><span class="line"><span class="cl">    text += &#34;TABLE &#34; + preparer.format_table(table) + &#34; &#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    create_table_suffix = self.create_table_suffix(table)
</span></span><span class="line"><span class="cl">    if create_table_suffix:
</span></span><span class="line"><span class="cl">        text += create_table_suffix + &#34; &#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    text += &#34;(&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    separator = &#34;\n&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # if only one primary key, specify it along with the column
</span></span><span class="line"><span class="cl">    first_pk = False
</span></span><span class="line"><span class="cl">    for create_column in create.columns:
</span></span><span class="line"><span class="cl">        column = create_column.element
</span></span><span class="line"><span class="cl">        try:
</span></span><span class="line"><span class="cl">            processed = self.process(
</span></span><span class="line"><span class="cl">                create_column, first_pk=column.primary_key and not first_pk
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">            if processed is not None:
</span></span><span class="line"><span class="cl">                text += separator
</span></span><span class="line"><span class="cl">                separator = &#34;, \n&#34;
</span></span><span class="line"><span class="cl">                text += &#34;\t&#34; + processed
</span></span><span class="line"><span class="cl">            if column.primary_key:
</span></span><span class="line"><span class="cl">                first_pk = True
</span></span><span class="line"><span class="cl">        except exc.CompileError as ce:
</span></span><span class="line"><span class="cl">            ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    const = self.create_table_constraints(
</span></span><span class="line"><span class="cl">        table,
</span></span><span class="line"><span class="cl">        _include_foreign_key_constraints=create.include_foreign_key_constraints,  # noqa
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    if const:
</span></span><span class="line"><span class="cl">        text += separator + &#34;\t&#34; + const
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    text += &#34;\n)%s\n\n&#34; % self.post_create_table(table)
</span></span><span class="line"><span class="cl">    return text
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def visit_create_column(self, create, first_pk=False):
</span></span><span class="line"><span class="cl">    column = create.element
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    text = self.get_column_specification(column, first_pk=first_pk)
</span></span><span class="line"><span class="cl">    const = &#34; &#34;.join(
</span></span><span class="line"><span class="cl">        self.process(constraint) for constraint in column.constraints
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">    if const:
</span></span><span class="line"><span class="cl">        text += &#34; &#34; + const
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return text
</span></span></code></pre></td></tr></table>
</div>
</div><p>在前面column介绍中，我们略过了数据类型。大家都知道sql的数据类型和python数据类型有差异, 下面是一些常见的SQL数据类型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class TypeEngine(Visitable):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class Integer(_LookupExpressionAdapter, TypeEngine):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;integer&#34;
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class String(Concatenable, TypeEngine):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;string&#34;
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class CHAR(String):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;CHAR&#34;
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class VARCHAR(String):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;VARCHAR&#34;
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>数据类型由GenericTypeCompiler进行编译:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class TypeCompiler(util.with_metaclass(util.EnsureKWArgType, object)):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def process(self, type_, **kw):
</span></span><span class="line"><span class="cl">        return type_._compiler_dispatch(self, **kw)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class GenericTypeCompiler(TypeCompiler):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def visit_INTEGER(self, type_, **kw):
</span></span><span class="line"><span class="cl">        return &#34;INTEGER&#34;
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    def visit_string(self, type_, **kw):
</span></span><span class="line"><span class="cl">        return self.visit_VARCHAR(type_, **kw)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def visit_VARCHAR(self, type_, **kw):
</span></span><span class="line"><span class="cl">        return self._render_string_type(type_, &#34;VARCHAR&#34;)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def _render_string_type(self, type_, name):
</span></span><span class="line"><span class="cl">        text = name
</span></span><span class="line"><span class="cl">        if type_.length:
</span></span><span class="line"><span class="cl">            text += &#34;(%d)&#34; % type_.length
</span></span><span class="line"><span class="cl">        if type_.collation:
</span></span><span class="line"><span class="cl">            text += &#39; COLLATE &#34;%s&#34;&#39; % type_.collation
</span></span><span class="line"><span class="cl">        return text
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="dmldata-manipulation-language使用insert插入数据">DML(Data Manipulation Language)使用insert插入数据</h2>
<p>数据插入的API由TableClause提供的insert函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class TableClause(Immutable, FromClause):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    @util.dependencies(&#34;sqlalchemy.sql.dml&#34;)
</span></span><span class="line"><span class="cl">    def insert(self, dml, values=None, inline=False, **kwargs):
</span></span><span class="line"><span class="cl">        return dml.Insert(self, values=values, inline=inline, **kwargs)
</span></span></code></pre></td></tr></table>
</div>
</div><p>dml中提供了Insert类的实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class UpdateBase(
</span></span><span class="line"><span class="cl">    HasCTE, DialectKWArgs, HasPrefixes, Executable, ClauseElement
</span></span><span class="line"><span class="cl">):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class ValuesBase(UpdateBase):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class Insert(ValuesBase):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;insert&#34;
</span></span><span class="line"><span class="cl">    ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>按照ddl的经验，我们查找insert语句的编译方法，在SQLCompiler中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SQLCompiler(Compiled):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def visit_insert(self, insert_stmt, asfrom=False, **kw):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        crud_params = crud._setup_crud_params(
</span></span><span class="line"><span class="cl">            self, insert_stmt, crud.ISINSERT, **kw
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if insert_stmt._has_multi_parameters:
</span></span><span class="line"><span class="cl">            crud_params_single = crud_params[0]
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            crud_params_single = crud_params
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        preparer = self.preparer
</span></span><span class="line"><span class="cl">        supports_default_values = self.dialect.supports_default_values
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        text = &#34;INSERT &#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        text += &#34;INTO &#34;
</span></span><span class="line"><span class="cl">        table_text = preparer.format_table(insert_stmt.table)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if crud_params_single or not supports_default_values:
</span></span><span class="line"><span class="cl">            text += &#34; (%s)&#34; % &#34;, &#34;.join(
</span></span><span class="line"><span class="cl">                [preparer.format_column(c[0]) for c in crud_params_single]
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        if insert_stmt.select is not None:
</span></span><span class="line"><span class="cl">            select_text = self.process(self._insert_from_select, **kw)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            if self.ctes and toplevel and self.dialect.cte_follows_insert:
</span></span><span class="line"><span class="cl">                text += &#34; %s%s&#34; % (self._render_cte_clause(), select_text)
</span></span><span class="line"><span class="cl">            else:
</span></span><span class="line"><span class="cl">                text += &#34; %s&#34; % select_text
</span></span><span class="line"><span class="cl">        elif not crud_params and supports_default_values:
</span></span><span class="line"><span class="cl">            text += &#34; DEFAULT VALUES&#34;
</span></span><span class="line"><span class="cl">        elif insert_stmt._has_multi_parameters:
</span></span><span class="line"><span class="cl">            text += &#34; VALUES %s&#34; % (
</span></span><span class="line"><span class="cl">                &#34;, &#34;.join(
</span></span><span class="line"><span class="cl">                    &#34;(%s)&#34; % (&#34;, &#34;.join(c[1] for c in crud_param_set))
</span></span><span class="line"><span class="cl">                    for crud_param_set in crud_params
</span></span><span class="line"><span class="cl">                )
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            text += &#34; VALUES (%s)&#34; % &#34;, &#34;.join([c[1] for c in crud_params])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        return text
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到insert语句就是对Insert对象，通过字符串模版拼接而来。</p>
<h2 id="dqldata-query-language使用select查询数据">DQL(Data Query Language)使用select查询数据</h2>
<p>数据查询select语句也都有特定的数据结构Select，继承关系如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SelectBase(HasCTE, Executable, FromClause):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class GenerativeSelect(SelectBase):
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">class Select(HasPrefixes, HasSuffixes, GenerativeSelect):
</span></span><span class="line"><span class="cl">    __visit_name__ = &#34;select&#34;
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(
</span></span><span class="line"><span class="cl">        self,
</span></span><span class="line"><span class="cl">        columns=None,
</span></span><span class="line"><span class="cl">        whereclause=None,
</span></span><span class="line"><span class="cl">        from_obj=None,
</span></span><span class="line"><span class="cl">        distinct=False,
</span></span><span class="line"><span class="cl">        having=None,
</span></span><span class="line"><span class="cl">        correlate=True,
</span></span><span class="line"><span class="cl">        prefixes=None,
</span></span><span class="line"><span class="cl">        suffixes=None,
</span></span><span class="line"><span class="cl">        **kwargs
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        GenerativeSelect.__init__(self, **kwargs)
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>select的编译语句也在SQLCompiler中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class SQLCompiler(Compiled):
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def visit_select(
</span></span><span class="line"><span class="cl">        self,
</span></span><span class="line"><span class="cl">        select,
</span></span><span class="line"><span class="cl">        asfrom=False,
</span></span><span class="line"><span class="cl">        parens=True,
</span></span><span class="line"><span class="cl">        fromhints=None,
</span></span><span class="line"><span class="cl">        compound_index=0,
</span></span><span class="line"><span class="cl">        nested_join_translation=False,
</span></span><span class="line"><span class="cl">        select_wraps_for=None,
</span></span><span class="line"><span class="cl">        lateral=False,
</span></span><span class="line"><span class="cl">        **kwargs
</span></span><span class="line"><span class="cl">    ):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        froms = self._setup_select_stack(select, entry, asfrom, lateral)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        column_clause_args = kwargs.copy()
</span></span><span class="line"><span class="cl">        column_clause_args.update(
</span></span><span class="line"><span class="cl">            {&#34;within_label_clause&#34;: False, &#34;within_columns_clause&#34;: False}
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        text = &#34;SELECT &#34;  # we&#39;re off to a good start !
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        text += self.get_select_precolumns(select, **kwargs)
</span></span><span class="line"><span class="cl">        # the actual list of columns to print in the SELECT column list.
</span></span><span class="line"><span class="cl">        inner_columns = [
</span></span><span class="line"><span class="cl">            c
</span></span><span class="line"><span class="cl">            for c in [
</span></span><span class="line"><span class="cl">                self._label_select_column(
</span></span><span class="line"><span class="cl">                    select,
</span></span><span class="line"><span class="cl">                    column,
</span></span><span class="line"><span class="cl">                    populate_result_map,
</span></span><span class="line"><span class="cl">                    asfrom,
</span></span><span class="line"><span class="cl">                    column_clause_args,
</span></span><span class="line"><span class="cl">                    name=name,
</span></span><span class="line"><span class="cl">                )
</span></span><span class="line"><span class="cl">                for name, column in select._columns_plus_names
</span></span><span class="line"><span class="cl">            ]
</span></span><span class="line"><span class="cl">            if c is not None
</span></span><span class="line"><span class="cl">        ]
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        text = self._compose_select_body(
</span></span><span class="line"><span class="cl">            text, select, inner_columns, froms, byfrom, kwargs
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if select._statement_hints:
</span></span><span class="line"><span class="cl">            per_dialect = [
</span></span><span class="line"><span class="cl">                ht
</span></span><span class="line"><span class="cl">                for (dialect_name, ht) in select._statement_hints
</span></span><span class="line"><span class="cl">                if dialect_name in (&#34;*&#34;, self.dialect.name)
</span></span><span class="line"><span class="cl">            ]
</span></span><span class="line"><span class="cl">            if per_dialect:
</span></span><span class="line"><span class="cl">                text += &#34; &#34; + self.get_statement_hint_text(per_dialect)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if self.ctes and toplevel:
</span></span><span class="line"><span class="cl">            text = self._render_cte_clause() + text
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if select._suffixes:
</span></span><span class="line"><span class="cl">            text += &#34; &#34; + self._generate_prefixes(
</span></span><span class="line"><span class="cl">                select, select._suffixes, **kwargs
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        self.stack.pop(-1)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        if (asfrom or lateral) and parens:
</span></span><span class="line"><span class="cl">            return &#34;(&#34; + text + &#34;)&#34;
</span></span><span class="line"><span class="cl">        else:
</span></span><span class="line"><span class="cl">            return text
</span></span></code></pre></td></tr></table>
</div>
</div><p>select语句一样是采用字符串拼接得到。</p>
<h2 id="orm-示例">ORM 示例</h2>
<p>orm的使用和schema使用方式略有不同, 下面是orm的示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">from sqlalchemy import create_engine
</span></span><span class="line"><span class="cl">from sqlalchemy.ext.declarative import declarative_base
</span></span><span class="line"><span class="cl">from sqlalchemy import Column, Integer, String
</span></span><span class="line"><span class="cl">from sqlalchemy.orm import sessionmaker
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">engine = create_engine(&#39;sqlite:///:memory:&#39;, echo=True)
</span></span><span class="line"><span class="cl">Model = declarative_base()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class User(Model):
</span></span><span class="line"><span class="cl">    __tablename__ = &#39;users&#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    id = Column(Integer, primary_key=True)
</span></span><span class="line"><span class="cl">    name = Column(String)
</span></span><span class="line"><span class="cl">    fullname = Column(String)
</span></span><span class="line"><span class="cl">    nickname = Column(String)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __repr__(self):
</span></span><span class="line"><span class="cl">        return &#34;&lt;User(name=&#39;%s&#39;, fullname=&#39;%s&#39;, nickname=&#39;%s&#39;)&gt;&#34; % (
</span></span><span class="line"><span class="cl">            self.name, self.fullname, self.nickname)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Model.metadata.create_all(engine)
</span></span><span class="line"><span class="cl">print(&#34;=&#34;*10)
</span></span><span class="line"><span class="cl">Session = sessionmaker(bind=engine)
</span></span><span class="line"><span class="cl">session = Session()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ed_user = User(name=&#39;ed&#39;, fullname=&#39;Ed Jones&#39;, nickname=&#39;edsnickname&#39;)
</span></span><span class="line"><span class="cl">session.add(ed_user)
</span></span><span class="line"><span class="cl">session.commit()
</span></span><span class="line"><span class="cl">print(ed_user.id)
</span></span><span class="line"><span class="cl">result = engine.execute(&#34;select * from users&#34;)
</span></span><span class="line"><span class="cl">for row in result:
</span></span><span class="line"><span class="cl">    print(row)
</span></span></code></pre></td></tr></table>
</div>
</div><p>对比schema和orm的差异，可以得到下表:</p>
<table>
<thead>
<tr>
<th>schema方式</th>
<th>orm方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建engine，用于数据库连接</td>
<td>-</td>
</tr>
<tr>
<td>创建metadata，用于管理schema</td>
<td>创建Model</td>
</tr>
<tr>
<td>创建users表的Table</td>
<td>创建User模型</td>
</tr>
<tr>
<td>将metadata提交到engine(创建表)</td>
<td>-</td>
</tr>
<tr>
<td>-</td>
<td>创建session</td>
</tr>
<tr>
<td>使用users插入数据</td>
<td>使用session插入数据</td>
</tr>
</tbody>
</table>
<p>总结一下主要就2点差异：</p>
<ol>
<li>orm时候不用显示的创建表的schema</li>
<li>orm的数据处理都使用session来操作，而不是使用connection</li>
</ol>
<h2 id="model核心功能">model核心功能</h2>
<p>Model类使用declarative_base动态创建:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class DeclarativeMeta(type):
</span></span><span class="line"><span class="cl">    def __init__(cls, classname, bases, dict_):
</span></span><span class="line"><span class="cl">        if &#34;_decl_class_registry&#34; not in cls.__dict__:
</span></span><span class="line"><span class="cl">            _as_declarative(cls, classname, cls.__dict__)
</span></span><span class="line"><span class="cl">        type.__init__(cls, classname, bases, dict_)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __setattr__(cls, key, value):
</span></span><span class="line"><span class="cl">        _add_attribute(cls, key, value)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    def __delattr__(cls, key):
</span></span><span class="line"><span class="cl">        _del_attribute(cls, key)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def declarative_base(
</span></span><span class="line"><span class="cl">    bind=None,
</span></span><span class="line"><span class="cl">    metadata=None,
</span></span><span class="line"><span class="cl">    mapper=None,
</span></span><span class="line"><span class="cl">    cls=object,
</span></span><span class="line"><span class="cl">    name=&#34;Base&#34;,
</span></span><span class="line"><span class="cl">    constructor=_declarative_constructor,
</span></span><span class="line"><span class="cl">    class_registry=None,
</span></span><span class="line"><span class="cl">    metaclass=DeclarativeMeta,
</span></span><span class="line"><span class="cl">):
</span></span><span class="line"><span class="cl">    # 创建metadata
</span></span><span class="line"><span class="cl">    lcl_metadata = metadata or MetaData()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if class_registry is None:
</span></span><span class="line"><span class="cl">        class_registry = weakref.WeakValueDictionary()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    bases = not isinstance(cls, tuple) and (cls,) or cls
</span></span><span class="line"><span class="cl">    class_dict = dict(
</span></span><span class="line"><span class="cl">        _decl_class_registry=class_registry, metadata=lcl_metadata
</span></span><span class="line"><span class="cl">    )
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 构造函数
</span></span><span class="line"><span class="cl">    if constructor:
</span></span><span class="line"><span class="cl">        class_dict[&#34;__init__&#34;] = constructor
</span></span><span class="line"><span class="cl">    if mapper:
</span></span><span class="line"><span class="cl">        class_dict[&#34;__mapper_cls__&#34;] = mapper
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    # class-meta
</span></span><span class="line"><span class="cl">    return metaclass(name, bases, class_dict)
</span></span></code></pre></td></tr></table>
</div>
</div><p>关于如何动态创建类，在小技巧中进行介绍。declarative_base主要定义了Model类的几个特性：</p>
<ul>
<li>Model类的构造函数<code>__init__</code>使用_declarative_constructor</li>
<li>Model类的子类在构造的时候会调用_as_declarative</li>
<li>model对象会使用_add_attribute进行赋值</li>
</ul>
<p>先从构造函数_declarative_constructor开始:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def _declarative_constructor(self, **kwargs):
</span></span><span class="line"><span class="cl">    cls_ = type(self)
</span></span><span class="line"><span class="cl">    for k in kwargs:
</span></span><span class="line"><span class="cl">        if not hasattr(cls_, k):
</span></span><span class="line"><span class="cl">            raise TypeError(
</span></span><span class="line"><span class="cl">                &#34;%r is an invalid keyword argument for %s&#34; % (k, cls_.__name__)
</span></span><span class="line"><span class="cl">            )
</span></span><span class="line"><span class="cl">        setattr(self, k, kwargs[k])
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">_declarative_constructor.__name__ = &#34;__init__&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>看起来非常简单，但是这里做了一个类和对象实例之间的校验转换。我们先看一段演示代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class DummyModel(object):
</span></span><span class="line"><span class="cl">    name = [&#34;dummy_model&#34;]  # 引用类型
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">a = DummyModel()
</span></span><span class="line"><span class="cl">b = DummyModel()
</span></span><span class="line"><span class="cl">assert id(a.name) == id(b.name) == id(DummyModel.name)
</span></span><span class="line"><span class="cl">a.name.append(&#34;a&#34;)
</span></span><span class="line"><span class="cl">assert id(a.name) == id(b.name) == id(DummyModel.name)
</span></span></code></pre></td></tr></table>
</div>
</div><p>DummyModel的类属性name和a对象的name属性都是同一个引用。如果使用Model类:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Model = declarative_base()
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class UserModel(Model):
</span></span><span class="line"><span class="cl">    __tablename__ = &#39;user&#39;  # 必须字段
</span></span><span class="line"><span class="cl">    id = Column(Integer, primary_key=True)  # 必须字段
</span></span><span class="line"><span class="cl">    name = Column(String)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">c = UserModel()
</span></span><span class="line"><span class="cl">c.name = &#34;c&#34;
</span></span><span class="line"><span class="cl">d = UserModel()
</span></span><span class="line"><span class="cl">d.name = &#34;d&#34;
</span></span><span class="line"><span class="cl"># 注意并不是Column
</span></span><span class="line"><span class="cl">assert isinstance(UserModel.name, InstrumentedAttribute)
</span></span><span class="line"><span class="cl">assert isinstance(c.name, str)
</span></span><span class="line"><span class="cl">assert d.name == &#34;d&#34;
</span></span><span class="line"><span class="cl">assert id(c.name) != id(d.name) != id(UserModel.name)
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现UserModel的类属性name和d对象的name属性完全不一样，类定义的是Cloumn(InstrumentedAttribute)，对象变成了str。这个就是orm模型的特性之一，Model是定义格式模版，对象实例化后转化为普通数据。</p>
<p>Model的另外一个功能是隐式创建Table对象，在_as_declarative函数中通过_MapperConfig实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class _MapperConfig(object):
</span></span><span class="line"><span class="cl">    def setup_mapping(cls, cls_, classname, dict_):
</span></span><span class="line"><span class="cl">        cfg_cls = _MapperConfig
</span></span><span class="line"><span class="cl">        cfg_cls(cls_, classname, dict_)
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def __init__(self, cls_, classname, dict_):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        self._setup_table()
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    def _setup_table(self):
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">        table_cls = Table
</span></span><span class="line"><span class="cl">        args, table_kw = (), {}
</span></span><span class="line"><span class="cl">        if table_args:
</span></span><span class="line"><span class="cl">            if isinstance(table_args, dict):
</span></span><span class="line"><span class="cl">                table_kw = table_args
</span></span><span class="line"><span class="cl">            elif isinstance(table_args, tuple):
</span></span><span class="line"><span class="cl">                if isinstance(table_args[-1], dict):
</span></span><span class="line"><span class="cl">                    args, table_kw = table_args[0:-1], table_args[-1]
</span></span><span class="line"><span class="cl">                else:
</span></span><span class="line"><span class="cl">                    args = table_args
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        autoload = dict_.get(&#34;__autoload__&#34;)
</span></span><span class="line"><span class="cl">        if autoload:
</span></span><span class="line"><span class="cl">            table_kw[&#34;autoload&#34;] = True
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        cls.__table__ = table = table_cls(
</span></span><span class="line"><span class="cl">            tablename,
</span></span><span class="line"><span class="cl">            cls.metadata,
</span></span><span class="line"><span class="cl">            *(tuple(declared_columns) + tuple(args)),
</span></span><span class="line"><span class="cl">            **table_kw
</span></span><span class="line"><span class="cl">        )
</span></span><span class="line"><span class="cl">        ...
</span></span></code></pre></td></tr></table>
</div>
</div><p>而Column是通过下面的函数实现:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">def _add_attribute(cls, key, value):
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if &#34;__mapper__&#34; in cls.__dict__:
</span></span><span class="line"><span class="cl">        if isinstance(value, Column):
</span></span><span class="line"><span class="cl">            _undefer_column_name(key, value)
</span></span><span class="line"><span class="cl">            cls.__table__.append_column(value)
</span></span><span class="line"><span class="cl">            cls.__mapper__.add_property(key, value)
</span></span><span class="line"><span class="cl">        ...
</span></span><span class="line"><span class="cl">    else:
</span></span><span class="line"><span class="cl">        type.__setattr__(cls, key, value)
</span></span></code></pre></td></tr></table>
</div>
</div><p>Model通过上面的方式，隐式创建了Schema(Table)，实际使用过程中只需要使用Model类，不用关注Schema的定义。</p>
<blockquote>
<p>session的源码由于篇幅和时间有限，留待以后再行分析</p>
</blockquote>
<h2 id="小结">小结</h2>
<p>sqlalchemy可以在低层次上提供了sql语句的方式使用；在次层次上提供定义schema方式使用；在高层次上提供orm的实现，让应用可以根据项目的特点自主选择不同层级的API。</p>
<p>使用schema时候，主要使用Metadata，Table和Column等定义Schema数据结构，使用编译器自动将schema转换成合法的sql语句。</p>
<p>使用orm的时候，则是创建特定的数据模型，模型对象会隐式创建schema，通过session方式进行数据访问。</p>
<p>最后再回顾一下sqlalchemy的架构图:</p>
<p><img src="https://game404-1251284600.cos.ap-beijing.myqcloud.com/20210415214714.png" alt="architecture"></p>
<h2 id="小技巧">小技巧</h2>
<p>sqlalchemy中提供了一个动态创建类的方式，主要在declarative_base和DeclarativeMeta中实现。我参考这个实现方式做了一个类工厂:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">class DeclarativeMeta(type):
</span></span><span class="line"><span class="cl">    def __init__(cls, klass_name, bases, dict_):
</span></span><span class="line"><span class="cl">        print(&#34;class_init&#34;, klass_name, bases, dict_)
</span></span><span class="line"><span class="cl">        type.__init__(cls, klass_name, bases, dict_)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def get_attr(self, key):
</span></span><span class="line"><span class="cl">    print(&#34;getattr&#34;, self, key)
</span></span><span class="line"><span class="cl">    return self.__dict__[key]
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def constructor(self, *args, **kwargs):
</span></span><span class="line"><span class="cl">    print(&#34;constructor&#34;, self, args, kwargs)
</span></span><span class="line"><span class="cl">    for k, v in kwargs.items():
</span></span><span class="line"><span class="cl">        setattr(self, k, v)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">def dynamic_class(name):
</span></span><span class="line"><span class="cl">    class_dict = {
</span></span><span class="line"><span class="cl">        &#34;__init__&#34;: constructor,
</span></span><span class="line"><span class="cl">        &#34;__getattr__&#34;: get_attr
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return DeclarativeMeta(name, (object,), class_dict)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DummyModel = dynamic_class(&#34;Dummy&#34;)
</span></span><span class="line"><span class="cl">dummy = DummyModel(1, name=&#34;hello&#34;, age=18)
</span></span><span class="line"><span class="cl">print(dummy, type(dummy), dummy.name, dummy.age)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># class_init Dummy (&lt;class &#39;object&#39;&gt;,) {&#39;__init__&#39;: &lt;function test_dynamic_class.&lt;locals&gt;.constructor at 0x7f898827ef70&gt;, &#39;__getattr__&#39;: &lt;function test_dynamic_class.&lt;locals&gt;.get_attr at 0x7f89882105e0&gt;}
</span></span><span class="line"><span class="cl"># constructor &lt;sample.Dummy object at 0x7f89882a5820&gt; (1,) {&#39;name&#39;: &#39;hello&#39;, &#39;age&#39;: 18}
</span></span><span class="line"><span class="cl"># &lt;sample.Dummy object at 0x7f89882a5820&gt; &lt;class &#39;sample.Dummy&#39;&gt; hello 18
</span></span></code></pre></td></tr></table>
</div>
</div><p>示例中我动态创建了一个DummyModel类，<code>type(dummy)</code>可以看到，这个类名是 <strong>Dummy</strong>。这个类可以的构造函数可以接受name和age两个属性。这种创建方式和collections.namedtuple有点类似。</p>
<h2 id="一点感悟">一点感悟</h2>
<p>sqlalchemy的源码非常复杂，前前后后一共准备了一个月，形成的2篇文档仅仅涉及核心流程和用法，细节部分缺失较多，以后有机会还需要继续阅读。在这一个月中，克服了工作较忙，没有时间写稿的烦躁；克服了阅读进入困境，一度想放弃的心理障碍；克服了deadline临近，文稿还只是一个雏形，使用存稿顶替的羞愧；克服了笔记软件故障，写完的文稿丢失，完全重写的懊恼。战胜这些困难，最终还是得以完成，心理上有大满足。当然最大的收获还是对ORM中间件有了初步的了解，也希望梳理的ORM流程对大家有一定的帮助，如果获得大家的支持会更加满意♥️。</p>
<p>最后，欢迎加下面的微信和我互动交流，一起进阶:
<img src="https://game404-1251284600.cos.ap-beijing.myqcloud.com/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E7%99%BD%E8%89%B2%E7%89%88.png" alt="wx"></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">shawn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-04-29
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/database/">database</a>
          <a href="/tags/%E6%BA%90%E7%A0%81/">源码</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/python/xmlrpc/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">xmlrpc源码阅读</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/python/python-core-tools/">
            <span class="next-text nav-default">Python 冷兵器合集</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/gh/theme-next/theme-next-gitment@1/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '2021-04-29 22:38:13 \u002b0800 CST',
        title: 'SQLAlchemy源码阅读-下篇',
        link: decodeURI(location.href),
        desc: 'SQLAlchemy是Python SQL工具箱和ORM框架，它为应用程序开发人员提供了全面而灵活的SQL功能。它提供了一整套企业级持久化方案',
        owner: 'game404',
        repo: 'game404.github.io',
        oauth: {
          client_id: '28a86ccaa3184b49dfc4',
          client_secret: '15ab0f7c1445c0afb5e3d7a8995c89f2fd081eb7'
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:studyoo@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/game404" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/593f44b8da2f60006736604e" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://game404.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>game404</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137813525-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
