<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>kubernetes 1.14 升级指南 - 游戏不存在</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="shawn" /><meta name="description" content="一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。 升级" /><meta name="keywords" content="game, docker, kubernetes, python, go,  microservice" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />
<meta name="google-site-verification" content="Qzk5S1WaeGv-bmDYA5rCo0HemniTpED_o5PAvmPp-yo" />


<link rel="canonical" href="https://game404.github.io/post/kubernetes-1.14-upgrade-guide/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="kubernetes 1.14 升级指南" />
<meta property="og:description" content="一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。 升级" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://game404.github.io/post/kubernetes-1.14-upgrade-guide/" />
<meta property="article:published_time" content="2019-03-28T23:28:08&#43;08:00"/>
<meta property="article:modified_time" content="2019-03-28T23:28:08&#43;08:00"/>

<meta itemprop="name" content="kubernetes 1.14 升级指南">
<meta itemprop="description" content="一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。 升级">


<meta itemprop="datePublished" content="2019-03-28T23:28:08&#43;08:00" />
<meta itemprop="dateModified" content="2019-03-28T23:28:08&#43;08:00" />
<meta itemprop="wordCount" content="2738">



<meta itemprop="keywords" content="指南," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubernetes 1.14 升级指南"/>
<meta name="twitter:description" content="一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。 升级"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">游戏不存在</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">游戏不存在</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">kubernetes 1.14 升级指南</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-03-28 </span>
        <div class="post-category">
            <a href="/categories/kubernetes/"> kubernetes </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#升级准备">升级准备</a></li>
<li><a href="#升级主控节点">升级主控节点</a></li>
<li><a href="#其它控制节点升级">其它控制节点升级</a></li>
<li><a href="#业务节点升级">业务节点升级</a></li>
<li><a href="#附">附</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<blockquote>
<p>一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。</p>
</blockquote>

<h3 id="升级准备">升级准备</h3>

<p>本次升级主要参考官方<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade-1-14/">Upgrading kubeadm clusters from v1.13 to v1.14</a></p>

<p>升级之前注意事项(翻译自官方文档)：</p>

<ol>
<li>1.13.0以上，使用kubeadm部署的kubernetes集群</li>
<li>Swap分区需要disabled</li>
<li>集群的控制平面个数和etcd pods需要是确定的。</li>
<li>认真阅读release notes。</li>
<li>备份。主要是备份一些重要的组件，比如database等。虽然升级不会调整业务负载，仅仅调整kubernetes，但是备份总是没错的。</li>
<li>所有的容器都会被重启，因为hash值会变化。</li>
<li>只能够进行小版本的升级，并且升级过程不能够跳级，比如从1.y到1.y+1,而不能够从1.y到1.y+2</li>
</ol>

<p>按照要求查看<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.14.md">kubernetes 1.14 更改说明</a>重点阅读<strong>Urgent Upgrade Notes</strong>，结合自己业务，并没有发现特别重大的变动，可以放心升级。</p>

<p>kubernetes集群是按照<a href="https://juejin.im/post/5c9a49ace51d456c9d78dbef">kubernetes 1.13 全新安装指南</a>搭建，如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">[hall@192-168-10-21 ~]$ kubectl get nodes
NAME            STATUS   ROLES    AGE    VERSION
192-168-10-14   Ready    master   36h    v1.13.0
192-168-10-18   Ready    &lt;none&gt;   103d   v1.13.0
192-168-10-21   Ready    master   104d   v1.13.0</pre></td></tr></table>
</div>
</div>
<p>业务数据备份，就不用介绍了。实际上安全起见最好先在测试集群上进行升级，通过后再考虑正式集群的升级。</p>

<p>升级过程主要变化的是kubernetes系统服务，重点是kubelet，所以将kubelet配置备份一下更为稳妥，方法如下：</p>

<p>1 查看kubelet服务配置:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-94 ~]# systemctl status kubelet
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)
  Drop-In: /etc/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: active (running) since 二 2019-03-19 18:38:46 CST; 1 weeks 1 days ago
     Docs: https://kubernetes.io/docs/
 Main PID: 6033 (kubelet)
    Tasks: 17
   Memory: 59.1M
   CGroup: /system.slice/kubelet.service
           └─6033 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgroup-driver=cgroupfs --network-plugin=cni --pod-infra-container-image=re...</pre></td></tr></table>
</div>
</div>
<p>2 查看服务的配置文件 <code>10-kubeadm.conf</code> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-94 ~]# cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
# Note: This dropin only works with kubeadm and kubelet v1.11+
[Service]
Environment=&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;
Environment=&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;
# This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
# the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/sysconfig/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS</pre></td></tr></table>
</div>
</div>
<p>3 备份涉及的配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">/etc/kubernetes/bootstrap-kubelet.conf (可能并不存在，没有也没有关系)
/etc/kubernetes/kubelet.conf
/var/lib/kubelet/kubeadm-flags.env
/etc/sysconfig/kubelet</pre></td></tr></table>
</div>
</div>
<p>下面正式开始升级过程。</p>

<h3 id="升级主控节点">升级主控节点</h3>

<p>升级之前，一定要确保具有多个控制节点，这样可以保障集群的可用。单一控制节点，升级万一挂了，怕是比较麻烦。添加控制节点的方法，参考上文的kubernetes 1.13 全新安装指南。</p>

<p>如果没有特殊说明本文除 <code>kubectl</code> 以外的命令，都是使用 <strong>root</strong> 账号执行。</p>

<p>1 先检查一下repo源中kubeadm是否更新到 <strong>1.14.0</strong> 的版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">yum list --showduplicates kubeadm --disableexcludes=kubernetes</pre></td></tr></table>
</div>
</div>
<p>我本地的源没有找到 <strong>1.14.0</strong> 。 使用下面命令清理，后再行检查可以得到 <strong>1.14.0</strong></p>

<blockquote>
<p><code>yum --disablerepo=\* --enablerepo=kubernetes clean all</code></p>
</blockquote>

<p>2 再次查看kubeadm版本信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-21 ~]# kubeadm version
kubeadm version: &amp;version.Info{Major:&#34;1&#34;, Minor:&#34;13&#34;, GitVersion:&#34;v1.13.4&#34;, GitCommit:&#34;c27b913fddd1a6c480c229191a087698aa92f0b1&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2019-02-28T13:35:32Z&#34;, GoVersion:&#34;go1.11.5&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}</pre></td></tr></table>
</div>
</div>
<p>3 安装kubeadm工具</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">yum install -y kubeadm-1.14.0-0 --disableexcludes=kubernetes</pre></td></tr></table>
</div>
</div>
<p>4 确认kubeadm版本升级完成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-21 ~]# kubeadm version  
kubeadm version: &amp;version.Info{Major:&#34;1&#34;, Minor:&#34;14&#34;, GitVersion:&#34;v1.14.0&#34;, GitCommit:&#34;641856db18352033a0d96dbc99153fa3b27298e5&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2019-03-25T15:51:21Z&#34;, GoVersion:&#34;go1.12.1&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}</pre></td></tr></table>
</div>
</div>
<p>5 升级检查和方案</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-21 ~]# kubeadm upgrade plan
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with &#39;kubectl -n kube-system get cm kubeadm-config -oyaml&#39;
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.13.0
[upgrade/versions] kubeadm version: v1.14.0

Awesome, you&#39;re up-to-date! Enjoy!

kubeadm upgrade apply v1.14.0</pre></td></tr></table>
</div>
</div>
<blockquote>
<p>这里的提示信息和官方文档有出入，不过这是正常的信息。</p>
</blockquote>

<p>6 升级kubeadm到1.14</p>

<p><code>kubeadm upgrade apply v1.14.0</code></p>

<p>这个执行过程，视集群情况，大概会执行几分钟，输出信息也比较多，大概如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-21 ~]# kubeadm upgrade apply v1.14.0
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:

.....

[upgrade/staticpods] Component &#34;kube-scheduler&#34; upgraded successfully!
[upload-config] storing the configuration used in ConfigMap &#34;kubeadm-config&#34; in the &#34;kube-system&#34; Namespace
[kubelet] Creating a ConfigMap &#34;kubelet-config-1.14&#34; in namespace kube-system with the configuration for the kubelets in the cluster
[kubelet-start] Downloading configuration for the kubelet from the &#34;kubelet-config-1.14&#34; ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file &#34;/var/lib/kubelet/config.yaml&#34;
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy

[upgrade/successful] SUCCESS! Your cluster was upgraded to &#34;v1.14.0&#34;. Enjoy!

[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven&#39;t already done so.</pre></td></tr></table>
</div>
</div>
<p>7 检查CNI情况，确定是否要升级</p>

<p>kubernetes架构，网络部分确定Container Network Interface接口，具体实现交由其它组件。我的集群使用flannel，检查一下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">kubectl get pods -n kube-system
...
kubectl describe pod/kube-flannel-ds-amd64-5xxh7 -n kube-system
...
Image:         quay.io/coreos/flannel:v0.11.0-amd64</pre></td></tr></table>
</div>
</div>
<p>使用的是 <strong>0.11</strong>， 查看<a href="https://github.com/coreos/flannel/releases">flannel主页</a>得知已经是最新版，这一步不用处理。</p>

<p>8 升级kubectl和kubelet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">yum install -y kubelet-1.14.0-0 kubectl-1.14.0-0 --disableexcludes=kubernetes</pre></td></tr></table>
</div>
</div>
<p>9 重启kubelet</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">[root@192-168-10-21 ~]# systemctl restart kubelet
Warning: kubelet.service changed on disk. Run &#39;systemctl daemon-reload&#39; to reload units.
[root@192-168-10-21 ~]# systemctl daemon-reload
[root@192-168-10-21 ~]# systemctl restart kubelet</pre></td></tr></table>
</div>
</div>
<blockquote>
<p>实际上，重启kubelet失败，报错：<strong>Failed to start ContainerManager failed to initialise top level QOS containers</strong>。 排查过程请见附1</p>
</blockquote>

<p>10 检查升级结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">[hall@192-168-10-21 ~]$ kubectl get nodes
NAME            STATUS   ROLES    AGE    VERSION
192-168-10-14   Ready    master   38h    v1.13.0
192-168-10-18   Ready    &lt;none&gt;   103d   v1.13.0
192-168-10-21   Ready    master   104d   v1.14.0</pre></td></tr></table>
</div>
</div>
<p>192-168-10-21的状态为 <strong>Ready</strong> ，版本也变为 <strong>1.14.0</strong> ，主控节点升级成功。</p>

<h3 id="其它控制节点升级">其它控制节点升级</h3>

<ol>
<li><p>参考上文升级好kubeadm，kubectl和kubelet工具。</p></li>

<li><p>升级到1.14</p></li>
</ol>

<p>主控节点已经执行了检查和升级，192-168-10-14只需要执行 <code>kubeadm upgrade apply v1.14.0</code>。</p>

<blockquote>
<p>不幸的是，又遇到了一点状况 <strong>failed to get APIEndpoint information for this node</strong>，排查过程请见附2</p>
</blockquote>

<ol>
<li><p>重启kubelet</p></li>

<li><p>检查升级结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">[hall@192-168-10-21 ~]$ kubectl get nodes
NAME            STATUS   ROLES    AGE    VERSION
192-168-10-14   Ready    master   39h    v1.14.0
192-168-10-18   Ready    &lt;none&gt;   103d   v1.13.0
192-168-10-21   Ready    master   104d   v1.14.0</pre></td></tr></table>
</div>
</div></li>
</ol>

<h3 id="业务节点升级">业务节点升级</h3>

<p>1 临时备份</p>

<p>因为集群就一个业务节点，为安全起见，先调整一个控制节点，用于临时支撑业务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[tyhall51@192-168-10-21 ~]$ kubectl taint node 192-168-10-14 node-role.kubernetes.io/master-
node/192-168-10-14 untainted</pre></td></tr></table>
</div>
</div>
<p>然后业务节点临时增加污点，防止升级期间调度：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">[tyhall51@192-168-10-21 ~]$ kubectl drain 192-168-10-18 --ignore-daemonsets
node/192-168-10-18 cordoned
error: unable to drain node &#34;192-168-10-18&#34;, aborting command...

There are pending nodes to be drained:
 192-168-10-18
error: cannot delete Pods with local storage (use --delete-local-data to override): kube-system/elasticsearch-logging-0, kube-system/elasticsearch-logging-1, kube-system/monitoring-influxdb-8b7d57f5c-2bhlw</pre></td></tr></table>
</div>
</div>
<p>2 安装kubeadm工具</p>

<p>3 升级kubedam到1.14</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma"><span class="p">[</span><span class="nx">root</span><span class="err">@</span><span class="mi">192</span><span class="o">-</span><span class="mi">168</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">18</span> <span class="err">~</span><span class="p">]</span><span class="err">#</span> <span class="nx">kubeadm</span> <span class="nx">upgrade</span> <span class="nx">node</span> <span class="nx">config</span> <span class="o">--</span><span class="nx">kubelet</span><span class="o">-</span><span class="nx">version</span> <span class="nx">v1</span><span class="mf">.14.0</span>
<span class="p">[</span><span class="nx">kubelet</span><span class="o">-</span><span class="nx">start</span><span class="p">]</span> <span class="nx">Downloading</span> <span class="nx">configuration</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">kubelet</span> <span class="nx">from</span> <span class="nx">the</span> <span class="s">&#34;kubelet-config-1.14&#34;</span> <span class="nx">ConfigMap</span> <span class="nx">in</span> <span class="nx">the</span> <span class="nx">kube</span><span class="o">-</span><span class="nx">system</span> <span class="nx">namespace</span>
<span class="p">[</span><span class="nx">kubelet</span><span class="o">-</span><span class="nx">start</span><span class="p">]</span> <span class="nx">Writing</span> <span class="nx">kubelet</span> <span class="nx">configuration</span> <span class="nx">to</span> <span class="nx">file</span> <span class="s">&#34;/var/lib/kubelet/config.yaml&#34;</span>
<span class="p">[</span><span class="nx">upgrade</span><span class="p">]</span> <span class="nx">The</span> <span class="nx">configuration</span> <span class="k">for</span> <span class="nx">this</span> <span class="nx">node</span> <span class="nx">was</span> <span class="nx">successfully</span> <span class="nx">updated</span><span class="p">!</span>
<span class="p">[</span><span class="nx">upgrade</span><span class="p">]</span> <span class="nx">Now</span> <span class="nx">you</span> <span class="nx">should</span> <span class="k">go</span> <span class="nx">ahead</span> <span class="nx">and</span> <span class="nx">upgrade</span> <span class="nx">the</span> <span class="nx">kubelet</span> <span class="kn">package</span> <span class="nx">using</span> <span class="nx">your</span> <span class="kn">package</span> <span class="nx">manager</span><span class="p">.</span></pre></td></tr></table>
</div>
</div>
<p>4 升级kubectl和kubelet</p>

<p>kubelet同样需要重启</p>

<p>5 还原临时备份</p>

<p>先取消业务节点污点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[tyhall51@192-168-10-21 ~]$ kubectl uncordon 192-168-10-18
node/192-168-10-18 uncordoned</pre></td></tr></table>
</div>
</div>
<p>然后还原master节点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[tyhall51@192-168-10-21 ~]$ kubectl taint node 192-168-10-14 node-role.kubernetes.io/master=:NoSchedule
node/192-168-10-14 tainted</pre></td></tr></table>
</div>
</div>
<p>6 检查结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">[tyhall51@192-168-10-21 ~]$ kubectl get nodes
NAME            STATUS   ROLES    AGE    VERSION
192-168-10-14   Ready    master   40h    v1.14.0
192-168-10-18   Ready    &lt;none&gt;   103d   v1.14.0
192-168-10-21   Ready    master   104d   v1.14.0</pre></td></tr></table>
</div>
</div>
<p>以上，完成了kubernetes从1.13到1.14的升级，整体上讲，升级过程比较轻松。总结一下升级过程:</p>

<ol>
<li>详细阅读升级指南，完成重要业务信息备份，完成kubelet配置。</li>
<li>升级主要控制节点。</li>
<li>升级其它控制节点。</li>
<li>升级业务节点。</li>
</ol>

<h3 id="附">附</h3>

<ol>
<li>kubelet重启失败</li>
</ol>

<p>kubelet重启失败，<code>systemctl status kubelet</code> 中错误信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">Failed to start ContainerManager failed to initialise top level QOS containers</pre></td></tr></table>
</div>
</div>
<p>参考<a href="https://github.com/kubernetes/kubernetes/issues/43704提示在kubelet启动时候增加">https://github.com/kubernetes/kubernetes/issues/43704提示在kubelet启动时候增加</a> &ndash;cgroups-per-qos=false &ndash;enforce-node-allocatable=&ldquo;&rdquo; 即可解决。之前备份kubelet的配置时候知道 <code>/var/lib/kubelet/kubeadm-flags.env</code> 中定义kubelet的启动参数，在其中加上，重启kubelet，恢复正常。</p>

<ol>
<li>kubeadm 升级失败
<code>
[root@192-168-10-14 ~]# kubeadm upgrade apply v1.14.0
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[upgrade/config] FATAL: failed to getAPIEndpoint: failed to get APIEndpoint information for this node
</code>
根据提示，使用编辑 <code>kubectl -n kube-system edit cm kubeadm-config -oyaml</code> kubeadm-config, 调整apiEndpoints为:
<code>
apiEndpoints:
  192-168-10-21:
    advertiseAddress: 192.168.10.21
    bindPort: 6443
  192-168-10-14:
    advertiseAddress: 192.168.10.14
    bindPort: 6443
</code>
继续执行kubeadm upgrade apply v1.14.0，正常完成。</li>
</ol>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">shawn</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-03-28
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%8C%87%E5%8D%97/">指南</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/python-env-2019/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python虚拟环境指南2019版</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/kubernetes-1.13-guide/">
            <span class="next-text nav-default">kubernetes 1.13 安装指南</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="comments-gitment"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitment@0.0.3/style/default.min.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitment@0.0.3/dist/gitment.browser.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitment = new Gitment({
        id: '2019-03-28 23:28:08 \x2b0800 CST',
        title: 'kubernetes 1.14 升级指南',
        link: decodeURI(location.href),
        desc: '一点题外话：kubernetes官方3月25号发布1.14，本文28号完成。1.14升级安装中文指南，目前全网大概最新吧，支持请赏个赞。 升级',
        owner: 'game404',
        repo: 'https:\/\/github.com\/game404\/game404.github.io.git',
        oauth: {
          client_id: '28a86ccaa3184b49dfc4',
          client_secret: '15ab0f7c1445c0afb5e3d7a8995c89f2fd081eb7'
        }
      });
      gitment.render('comments-gitment');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:studyoo@foxmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/game404" class="iconfont icon-github" title="github"></a>
      <a href="https://juejin.im/user/593f44b8da2f60006736604e" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://game404.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">game404</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-137813525-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
